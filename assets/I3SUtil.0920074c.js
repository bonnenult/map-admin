import{gm as J,gn as K,bO as O,go as U,cv as E,gp as fe,gq as he,gr as pe,bC as de,gs as ge,b0 as T,b5 as R,c4 as b,c6 as ye,cT as me,gt as V,gu as be,bc as we,gv as Me,gw as Se,ar as Z,cn as ve,gx as v,gy as xe,gz as qe,gc as Te,gA as _,cz as x,cd as S,gB as D,bL as C,gC as Re,gD as N,gE as X,gF as ze,gG as Y,gH as ke,gI as Q,cg as $,cf as We,gJ as Ce,gK as Fe,gL as Ie,bN as ee,ce as te,gM as q,es as P,d_ as Ae}from"./vendor.c8f3cc8c.js";import{C as Ge}from"./I3SBinaryReader.465d8dc4.js";function Le(e,t,n,a){const o=Ke(e,t,n),r=K();return J(n,o,r,a),r}const ne=1,ae=5-ne;function Ke(e,t,n){const a=O(),o=e[3],r=2**(Math.ceil(Math.log(o)*Math.LOG2E/ae)*ae+ne);if(n.isGeographic){const c=r/U(n).radius*180/Math.PI,l=Math.round(e[1]/c),d=Math.max(-90,Math.min(90,l*c)),p=c/Math.cos((Math.abs(d)-c/2)/180*Math.PI),g=Math.round(e[0]/p)*p;a[0]=g,a[1]=d}else{const c=Math.round(e[0]/r),l=Math.round(e[1]/r);a[0]=c*r,a[1]=l*r}const s=e[2]+t,i=Math.round(s/r);return a[2]=i*r,a}function re(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}function ut(e){if(de("disable-feature:i3s-draco")||!e)return!1;for(const n of e)for(const a of n.geometryBuffers){var t;if(((t=a.compressedAttributes)==null?void 0:t.encoding)==="draco")return!0}return!1}function ft(e,t,n,a,o,r){o.traverse(n,s=>{let i=s.mbs;t!==a&&(i=Oe,ge(s.mbs,a,i,t));const c=Ee(e,i);return c!==0&&(r(s,c),!0)})}function ht(e,t,n){let a=0,o=0;for(let r=0;r<t.length&&a<e.length;r++)e[a]===t[r]&&(n(r)&&(e[o]=e[a],o++),a++);e.length=o}function pt(e,t,n){let a=0,o=0;for(;a<n.length;)xe(e,n[a])>=0===t&&(n[o]=n[a],o++),a++;n.length=o}const z=E();function dt(e,t){if(t.rotationScale[1]===0&&t.rotationScale[2]===0&&t.rotationScale[3]===0&&t.rotationScale[5]===0&&t.rotationScale[6]===0&&t.rotationScale[7]===0)return z[0]=(e[0]-t.position[0])/t.rotationScale[0],z[1]=(e[1]-t.position[1])/t.rotationScale[4],z[2]=(e[2]-t.position[0])/t.rotationScale[0],z[3]=(e[3]-t.position[1])/t.rotationScale[4],z}const Oe=Fe();function Ee(e,t){const n=t[0],a=t[1],o=t[3],r=e[0]-n,s=n-e[2],i=e[1]-a,c=a-e[3],l=Math.max(r,s,0),d=Math.max(i,c,0),p=l*l+d*d;return p>o*o?0:p>0?1:-Math.max(r,s,i,c)>o?3:2}function Pe(e,t,n){const a=[],o=n&&n.missingFields,r=n&&n.originalFields;for(const s of e){const i=s.toLowerCase();let c=!1;for(const l of t)if(i===l.name.toLowerCase()){a.push(l.name),c=!0,r&&r.push(s);break}!c&&o&&o.push(s)}return a}async function gt(e,t,n,a,o){if(t.length===0)return[];const r=e.attributeStorageInfo;if(T(e.associatedLayer))try{return await Be(e.associatedLayer,t,n,a)}catch(s){if(e.associatedLayer.loaded)throw s}if(r){const s=je(t,n,o);if(R(s))throw new b("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const i=e.parsedUrl.path,c=await Promise.all(s.map(l=>He(i,r,l.node,l.indices,a).then(d=>{for(let p=0;p<l.graphics.length;p++){const g=l.graphics[p],f=d[p];if(g.attributes)for(const h in g.attributes)h in f||(f[h]=g.attributes[h]);g.attributes=f}return l.graphics})));return V(c)}throw new b("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function je(e,t,n){const a=new Map,o=[],r=n();for(const s of e){const i=s.attributes[t];for(let c=0;c<r.length;c++){const l=r[c],d=l.featureIds.indexOf(i);if(d>=0){let p=a.get(l.node);p||(p={node:l.node,indices:[],graphics:[]},o.push(p),a.set(l.node,p)),p.indices.push(d),p.graphics.push(s);for(let g=c;g>0;g--)r[g]=r[g-1];r[0]=l;break}}}return o}async function Be(e,t,n,a){t.sort((c,l)=>c.attributes[n]-l.attributes[n]);const o=t.map(c=>c.attributes[n]),r=[],s=Pe(a,e.fields,{originalFields:r}),i=await oe(e,o,s);for(let c=0;c<t.length;c++){const l=t[c],d=i[c],p={};if(l.attributes)for(const g in l.attributes)p[g]=l.attributes[g];for(let g=0;g<r.length;g++)p[r[g]]=d[s[g]];l.attributes=p}return t}function oe(e,t,n){const a=e.capabilities.query.maxRecordCount;if(a!=null&&t.length>a){const r=be(t,a);return Promise.all(r.map(s=>oe(e,s,n))).then(V)}const o=new we({objectIds:t,outFields:n,orderByFields:[e.objectIdField]});return e.queryFeatures(o).then(r=>{if(r&&r.features&&r.features.length===t.length)return r.features.map(s=>s.attributes);throw new b("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")})}function He(e,t,n,a,o){const r=[];for(const s of t)if(s&&o.indexOf(s.name)!==-1){const i=`${e}/nodes/${n.resources.attributes}/attributes/${s.key}/0`;r.push({url:i,storageInfo:s})}return ye(r.map(s=>me(s.url,{responseType:"array-buffer"}).then(i=>Ge(s.storageInfo,i.data)))).then(s=>{const i=[];for(const c of a){const l={};for(let d=0;d<s.length;d++)s[d].value!=null&&(l[r[d].storageInfo.name]=Ve(s[d].value,c));i.push(l)}return i})}const Je=-32768,Ue=-(2**31);function Ve(e,t){if(!e)return null;const n=e[t];return Me(e)?n===Je?null:n:Se(e)?n===Ue?null:n:n!=n?null:n}function Ze(e){const t=e.store.indexCRS||e.store.geographicCRS,n=t===void 0?e.store.indexWKT:void 0;if(n){if(!e.spatialReference)throw new b("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indeWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new b("layerview:store-spatial-reference-wkt-index-incompatible","The indeWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=t?new Z(re(t)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function _e(e){const t=e.store.vertexCRS||e.store.projectedCRS,n=t===void 0?e.store.vertexWKT:void 0;if(n){if(!e.spatialReference)throw new b("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new b("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=t?new Z(re(t)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function yt(e,t){return R(t)?"@null":t===v(t)?"@ECEF":e.equals(t)?"":t.wkid!=null?"@"+t.wkid:null}function j(e,t,n){if(!ve(e,t))throw new b("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if(n==="local"&&!De(e,t))throw new b("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{})}function De(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}function Ne(e,t,n){const a=Ze(e),o=_e(e);j(a,t,n),j(o,t,n)}function Xe(e){return(e.geometryType==null||e.geometryType==="triangles")&&(e.topology==null||e.topology==="PerAttributeArray")&&e.vertexAttributes!=null&&e.vertexAttributes.position!=null}function mt(e){if(e.store==null||e.store.defaultGeometrySchema==null||!Xe(e.store.defaultGeometrySchema))throw new b("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path})}function bt(e,t){Ne(e,t.spatialReference,t.viewingMode)}function Ye(e){return e.geometryType!=null&&e.geometryType==="points"&&(e.topology==null||e.topology==="PerAttributeArray")&&(e.encoding==null||e.encoding===""||e.encoding==="lepcc-xyz")&&e.vertexAttributes!=null&&e.vertexAttributes.position!=null}function wt(e){if(e.store==null||e.store.defaultGeometrySchema==null||!Ye(e.store.defaultGeometrySchema))throw new b("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function Mt(e,t){j(e.spatialReference,t.spatialReference,t.viewingMode)}function Qe(e){return e.type==="simple"||e.type==="class-breaks"||e.type==="unique-value"}function $e(e){return e.type==="mesh-3d"}function St(e){if(e==null||!Qe(e)||(e.type==="unique-value"||e.type==="class-breaks")&&e.defaultSymbol==null)return!0;const t=e.getSymbols();if(t.length===0)return!0;for(const n of t){if(!$e(n)||n.symbolLayers.length===0)return!0;for(const a of n.symbolLayers.items)if(a.type!=="fill"||R(a.material)||R(a.material.color)||a.material.colorMixMode!=="replace")return!0}return!1}const vt=fe({color:[0,0,0,0],opacity:0});class et{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function xt(e){const t=new et;let n=!1,a=!1;for(const o of e.symbolLayers.items)if(o.type==="fill"&&o.enabled){const r=o.material,s=o.edges;if(T(r)&&!n){const i=r.color,c=qe(r.colorMixMode);T(i)?t.material={color:[i.r/255,i.g/255,i.b/255],alpha:i.a,colorMixMode:c}:t.material={color:[1,1,1],alpha:1,colorMixMode:1},t.castShadows=o.castShadows,n=!0}T(s)&&!a&&(t.edgeMaterial=Te(s,{}),a=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:1}),t}function qt(e,t){return(0|e)+(0|t)|0}function tt(e,t,n,a,o=0){a===v(a)?t.isGeographic?it(e,n,t,o):st(e,n,t,o):t.isWGS84&&(a.isWebMercator||_(a))?nt(t,e,a,n,o):t.isWebMercator&&_(a)?ot(t,e,a,n,o):e===n?(n.center[2]+=o,x(n.center,t,0,n.center,a,0,1)):(S(n.center,e.center[0],e.center[1],e.center[2]+o),x(n.center,t,0,n.center,a,0,1),D(n.quaternion,e.quaternion),C(n.halfSize,e.halfSize))}function nt(e,t,n,a,o){C(M,t.center),M[2]+=o;const r=v(n);x(M,e,0,M,r,0,1),ie(r,t,M,n,a)}const F=new Float64Array(24),at={data:F,size:3},se=O(),M=O(),rt=Ie();function ot(e,t,n,a,o){C(M,t.center),M[2]+=o,ie(e,t,M,n,a)}function ie(e,t,n,a,o){const r=Re(rt,t.quaternion);for(let s=0;s<8;++s){for(let i=0;i<3;++i)se[i]=t.halfSize[i]*((s&1<<i)!=0?-1:1);for(let i=0;i<3;++i){let c=n[i];for(let l=0;l<3;++l)c+=se[l]*r[3*l+i];F[3*s+i]=c}}x(F,e,0,F,a,0,8),N(at,o)}function st(e,t,n,a){X(e,B),S(t.center,e.center[0],e.center[1],e.center[2]+a),J(n,t.center,m,v(n)),S(t.center,m[12],m[13],m[14]);const o=2*Math.sqrt(1+m[0]+m[5]+m[10]);w[0]=(m[6]-m[9])/o,w[1]=(m[8]-m[2])/o,w[2]=(m[1]-m[4])/o,w[3]=.25*o,ze(t.quaternion,w,e.quaternion),Y(w,t.quaternion);let r=0,s=0,i=0;for(const c of B)c[2]+=a,x(c,n,0,c,v(n),0,1),ke(u,c,t.center),Q(u,u,w),r=Math.max(r,Math.abs(u[0])),s=Math.max(s,Math.abs(u[1])),i=Math.max(i,Math.abs(u[2]));S(t.halfSize,r,s,i)}function it(e,t,n,a){const o=U(n),r=1+Math.max(0,a)/(o.radius+e.center[2]);S(t.center,e.center[0],e.center[1],e.center[2]+a),x(t.center,n,0,t.center,v(n),0,1),D(t.quaternion,e.quaternion),Y(w,e.quaternion),S(u,0,0,1),Q(u,u,w),S(u,e.halfSize[0]*Math.abs(u[0]),e.halfSize[1]*Math.abs(u[1]),e.halfSize[2]*Math.abs(u[2])),$(u,u,o.inverseFlattening),We(t.halfSize,e.halfSize,u),$(t.halfSize,t.halfSize,r)}function Tt(e,t,n,a,o,r){if(!r||r.length===0||R(t))return null;const s=Le(e.mbs,o,n,t);let i;Ce(A,s);const c=()=>{if(!i)if(i=B,ee(I),T(e.serviceObb)){tt(e.serviceObb,n,ce,t,o),X(ce,i);for(const f of i)q(f,f,A),P(I,f)}else{const f=e.mbs,h=f[3];te(f,n,u,t),q(u,u,A),u[2]+=o;for(let y=0;y<8;++y){const k=1&y?h:-h,G=2&y?h:-h,L=4&y?h:-h,W=i[y];C(W,[u[0]+k,u[1]+G,u[2]+L]),P(I,W)}}};let l=1/0,d=-1/0;const p=f=>{if(f.type!=="replace")return;const h=f.geometry;if(!h.hasZ)return;ee(H);const y=h.spatialReference||a,k=h.rings.reduce((G,L)=>L.reduce((W,ue)=>(te(ue,y,u,t),q(u,u,A),P(H,u),Math.min(u[2],W)),G),1/0);c(),Ae(I,H)&&(l=Math.min(l,k),d=Math.max(d,k))};if(r.forEach(f=>p(f)),l===1/0)return null;const g=(f,h,y)=>{q(u,y,s),f[h+0]=u[0],f[h+1]=u[1],f[h+2]=u[2],h+=24,y[2]=l,q(u,y,s),f[h+0]=u[0],f[h+1]=u[1],f[h+2]=u[2],h+=24,y[2]=d,q(u,y,s),f[h+0]=u[0],f[h+1]=u[1],f[h+2]=u[2]};for(let f=0;f<8;++f)g(le.data,3*f,i[f]);return N(le)}const m=K(),w=he(),B=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],H=E(),I=E(),ce=pe(),u=[0,0,0],le={data:new Array(72),size:3},A=K();export{xt as A,tt as C,qt as I,mt as M,Mt as R,Ne as S,St as W,ut as X,ft as Y,Tt as Z,ht as _,Le as a,yt as b,Ve as c,Ze as d,pt as e,j as g,Ke as h,gt as i,Ee as n,wt as q,dt as r,Pe as s,bt as x,_e as y,vt as z};
