import{cw as w,eH as _,aY as d,aZ as l,a_ as R,a$ as z,g1 as P,e8 as W,bS as S,aC as b,nZ as E}from"./vendor.47ccae81.js";import{g as H}from"./Bitmap.cada6152.js";const $=Math.PI/180;function N(e){return e*$}function q(e,i){const h=N(i.rotation),t=Math.abs(Math.cos(h)),a=Math.abs(Math.sin(h)),[o,s]=i.size;return e[0]=Math.round(s*a+o*t),e[1]=Math.round(s*t+o*a),e}function j(e,i,h,t){const[a,o]=i,[s,r]=t,m=.5*h;return e[0]=a-m*s,e[1]=o-m*r,e[2]=a+m*s,e[3]=o+m*r,e}const c=w(),g=[0,0],v=new _(0,0,0,0),x={container:null,fetchSource:null,requestUpdate:null,imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1};let p=class extends z{constructor(e){super(e),this._imagePromise=null,this.bitmaps=[],this.hidpi=x.hidpi,this.imageMaxWidth=x.imageMaxWidth,this.imageMaxHeight=x.imageMaxHeight,this.imageRotationSupported=x.imageRotationSupported,this.imageNormalizationSupported=x.imageNormalizationSupported,this.update=P(async(i,h)=>{if(!i.stationary||this.destroyed)return null;const t=i.state,a=W(t.spatialReference),o=this.hidpi?i.pixelRatio:1,s=this.imageNormalizationSupported&&t.worldScreenWidth&&t.worldScreenWidth<t.size[0];s?(g[0]=t.worldScreenWidth,g[1]=t.size[1]):this.imageRotationSupported?(g[0]=t.size[0],g[1]=t.size[1]):q(g,t);const r=Math.floor(g[0]*o)>this.imageMaxWidth||Math.floor(g[1]*o)>this.imageMaxHeight,m=a&&(t.extent.xmin<a.valid[0]||t.extent.xmax>a.valid[1]),f=!this.imageNormalizationSupported&&m,y=!r&&!f,M=this.imageRotationSupported?t.rotation:0;if(y){const n=s?t.paddedViewState.center:t.center;this._imagePromise=this._singleExport(t,g,n,t.resolution,M,o,h)}else{let n=Math.min(this.imageMaxWidth,this.imageMaxHeight);f&&(n=Math.min(t.worldScreenWidth,n)),this._imagePromise=this._tiledExport(t,n,M,o,h)}return this._imagePromise.then(async n=>{if(this._imagePromise=null,!this.destroyed){this.bitmaps=n!=null?n:[];for(const u of this.container.children)n.includes(u)||u.fadeOut().then(()=>{u.remove()});for(const u of n)this.container.addChild(u),u.fadeIn()}}).catch(n=>{throw this._imagePromise=null,n})},5e3)}destroy(){this.bitmaps=[]}get updating(){return!this.destroyed&&this._imagePromise!==null}updateExports(e){for(const i of this.container.children){if(!i.visible||!i.stage)return;e(i),i.invalidateTexture(),i.requestRender()}}async _export(e,i,h,t,a,o){const s=await this.fetchSource(e,Math.floor(i*a),Math.floor(h*a),{rotation:t,pixelRatio:a,signal:o}),r=new H(s,"additive");return r.x=e.xmin,r.y=e.ymax,r.resolution=e.width/i,r.rotation=t,r.pixelRatio=a,r}async _singleExport(e,i,h,t,a,o,s){j(c,h,t,i);const r=new S(c[0],c[1],c[2],c[3],e.spatialReference);return[await this._export(r,i[0],i[1],a,o,s)]}_tiledExport(e,i,h,t,a){const o=b.create({size:i,spatialReference:e.spatialReference,scales:[e.scale]}),s=new E(o),r=s.getTileCoverage(e);if(!r)return null;const m=[];return r.forEach((f,y,M,n)=>{v.set(f,y,M,n),s.getTileBounds(c,v);const u=new S(c[0],c[1],c[2],c[3],e.spatialReference);m.push(this._export(u,i,i,h,t,a))}),Promise.all(m)}};d([l()],p.prototype,"_imagePromise",void 0),d([l()],p.prototype,"bitmaps",void 0),d([l()],p.prototype,"container",void 0),d([l()],p.prototype,"fetchSource",void 0),d([l()],p.prototype,"hidpi",void 0),d([l()],p.prototype,"imageMaxWidth",void 0),d([l()],p.prototype,"imageMaxHeight",void 0),d([l()],p.prototype,"imageRotationSupported",void 0),d([l()],p.prototype,"imageNormalizationSupported",void 0),d([l()],p.prototype,"requestUpdate",void 0),d([l()],p.prototype,"updating",null),p=d([R("esri.views.2d.layers.support.ExportStrategy")],p);const B=p;export{B as S};
