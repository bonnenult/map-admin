var M=Object.defineProperty,S=Object.defineProperties;var V=Object.getOwnPropertyDescriptors;var P=Object.getOwnPropertySymbols;var O=Object.prototype.hasOwnProperty,T=Object.prototype.propertyIsEnumerable;var b=(r,a,e)=>a in r?M(r,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[a]=e,I=(r,a)=>{for(var e in a||(a={}))O.call(a,e)&&b(r,e,a[e]);if(P)for(var e of P(a))T.call(a,e)&&b(r,e,a[e]);return r},E=(r,a)=>S(r,V(a));import{e as i,d as n,hb as _,i as G,an as N,r as u,ei as Q,hv as R,ap as U,aM as q}from"./index.fe92decb.js";import{c as z}from"./ExportImageParameters.676cd283.js";import{t as D,d as L}from"./popupUtils.16f9871e.js";const J=r=>{let a=class extends r{initialize(){this.exportImageParameters=new z({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var e;return(e=this.exportImageParameters)==null||e.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(e,l){const{layer:c}=this;if(!e)return Promise.reject(new N("mapimagelayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:c}));const y=this.get("view.scale"),d=[],h=async t=>{const o=t.minScale===0||y<=t.minScale,s=t.maxScale===0||y>=t.maxScale;if(t.visible&&o&&s){if(t.sublayers)t.sublayers.forEach(h);else if(t.popupEnabled){const p=L(t,E(I({},l),{defaultPopupTemplateEnabled:!1}));u(p)&&d.unshift({sublayer:t,popupTemplate:p})}}},A=c.sublayers.toArray().reverse().map(h);await Promise.all(A);const F=d.map(async({sublayer:t,popupTemplate:o})=>{await t.load().catch(()=>{});const s=t.createQuery(),p=u(l)?l.event:null,f=Q({renderer:t.renderer,event:p}),v=this.createFetchPopupFeaturesQueryGeometry(e,f);if(s.geometry=v,s.outFields=await D(t,o),this.layer.type==="map-image"&&"floors"in this.view){var g,w;const j=(g=this.view)==null||(w=g.floors)==null?void 0:w.clone(),m=R(j,t);u(m)&&(s.where=s.where?`(${s.where}) AND (${m})`:m)}const x=await this._loadArcadeModules(o);return x&&x.arcadeUtils.hasGeometryOperations(o)||(s.maxAllowableOffset=v.width/f),(await t.queryFeatures(s)).features});return(await U(F)).reduce((t,o)=>o.value?[...t,...o.value]:t,[]).filter(t=>t!=null)}canResume(){var e;return!!super.canResume()&&((e=this.timeExtent)==null||!e.isEmpty)}_loadArcadeModules(e){if(e.get("expressionInfos.length")||Array.isArray(e.content)&&e.content.some(l=>l.type==="expression"))return q()}};return i([n()],a.prototype,"exportImageParameters",void 0),i([n({readOnly:!0})],a.prototype,"exportImageVersion",null),i([n()],a.prototype,"layer",void 0),i([n()],a.prototype,"suspended",void 0),i([n(_)],a.prototype,"timeExtent",void 0),a=i([G("esri.views.layers.MapImageLayerView")],a),a};export{J as y};
