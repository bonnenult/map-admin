import{dK as N,bA as W,eR as K,cT as q,eL as y,d0 as p,rJ as B,b1 as Q,fJ as Z,rK as $,rL as V,dM as J,dQ as ee}from"./vendor.c8f3cc8c.js";import{I as te,q as ae}from"./cimAnalyzer.ddfafba2.js";import{i as re,s as ie}from"./CIMSymbolHelper.05203bfb.js";import{m as se}from"./Rasterizer.b445121c.js";import"./BidiEngine.aae60613.js";import"./definitions.21e97413.js";import"./number.dfbabd3f.js";import"./GeometryUtils.d4e26b77.js";var D;(function(m){m.Legend="legend",m.Preview="preview"})(D||(D={}));const A=(m,e,t)=>{if(m&&m.targetSize){let s;if(t){const a=Math.max(t.frame.xmax-t.frame.xmin,t.frame.ymax-t.frame.ymin);s=m.targetSize/p(a)}else s=m.targetSize/e.referenceSize;return s}return m&&m.scaleFactor?m.scaleFactor:1},U={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:2,ymin:-2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};class de{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._pictureMarkerCache=new Map,this._textRasterizer=new re,this._cimResourceManager=new ie,this._rasterizer=new se(this._cimResourceManager)}async rasterizeCIMSymbolAsync(e,t,s,a,r,i,o,n){a=a||(t?t.centroid!=null?"esriGeometryPolygon":N(t.geometry):null)||oe(e);const c=await this.analyzeCIMSymbol(e,t?ne(t.attributes):null,s,a,n);return this.rasterizeCIMSymbol(c,t,a,r,i,o)}async analyzeCIMSymbol(e,t,s,a,r){const i=[],o=t?{geometryType:a,spatialReference:this._spatialReference,fields:t}:null;let n;await te(e.data,o,this._cimResourceManager,i,this._avoidSDF),W(r);for(const c of i)c.cim.type!=="CIMPictureMarker"&&c.cim.type!=="CIMPictureFill"&&c.cim.type!=="CIMPictureStroke"||(n||(n=[]),n.push(this.fetchPictureMarkerResource(c,r))),s&&c.type==="text"&&typeof c.text=="string"&&c.text.indexOf("[")>-1&&(c.text=K(s,c.text,c.cim.textCase));return n&&await Promise.all(n),i}async fetchPictureMarkerResource(e,t){const s=e.materialHash;if(!this._pictureMarkerCache.get(s)){const a=(await q(e.cim.url,{responseType:"image",signal:t&&t.signal})).data;this._pictureMarkerCache.set(s,a)}}rasterizeCIMSymbol(e,t,s,a,r,i){const o=[];for(const n of e){a&&typeof a.scaleFactor=="function"&&(a.scaleFactor=a.scaleFactor(t,r,i));const c=this._getRasterizedResource(n,t,s,a,r,i);if(!c)continue;let d=0,C=c.anchorX||0,g=c.anchorY||0,l=!1,f=0,h=0;if(s==="esriGeometryPoint"){const u=A(a,n,null);if(f=y(n.offsetX,t,r,i)*u||0,h=y(n.offsetY,t,r,i)*u||0,n.type==="marker")d=y(n.rotation,t,r,i)||0,l=!!n.rotateClockwise&&n.rotateClockwise;else if(n.type==="text"){if(d=y(n.angle,t,r,i)||0,n.horizontalAlignment!==void 0)switch(n.horizontalAlignment){case"left":C=-.5;break;case"right":C=.5;break;default:C=0}if(n.verticalAlignment!==void 0)switch(n.verticalAlignment){case"top":g=.5;break;case"bottom":g=-.5;break;case"baseline":g=-.25;break;default:g=0}}}c!=null&&o.push({angle:d,rotateClockWise:l,anchorX:C,anchorY:g,offsetX:f,offsetY:h,rasterizedResource:c})}return this.getSymbolImage(o)}getSymbolImage(e){const t=document.createElement("canvas"),s=t.getContext("2d");let a=0,r=0,i=0,o=0;const n=[];for(let g=0;g<e.length;g++){const l=e[g],f=l.rasterizedResource;if(!f)continue;const h=f.size,u=l.offsetX,M=l.offsetY,I=l.anchorX,P=l.anchorY,x=l.rotateClockWise||!1;let b=l.angle,z=p(u)-h[0]*(.5+I),w=p(M)-h[1]*(.5+P),k=z+h[0],S=w+h[1];if(b){x&&(b=-b);const _=Math.sin(b*Math.PI/180),v=Math.cos(b*Math.PI/180),T=z*v-w*_,X=z*_+w*v,Y=z*v-S*_,G=z*_+S*v,L=k*v-S*_,H=k*_+S*v,O=k*v-w*_,j=k*_+w*v;z=Math.min(T,Y,L,O),w=Math.min(X,G,H,j),k=Math.max(T,Y,L,O),S=Math.max(X,G,H,j)}a=z<a?z:a,r=w<r?w:r,i=k>i?k:i,o=S>o?S:o;const F=s.createImageData(f.size[0],f.size[1]);F.data.set(new Uint8ClampedArray(f.image.buffer));const E={offsetX:u,offsetY:M,rotateClockwise:x,angle:b,rasterizedImage:F,anchorX:I,anchorY:P};n.push(E)}t.width=i-a,t.height=o-r;const c=-a,d=o;for(let g=0;g<n.length;g++){const l=n[g],f=this._imageDataToCanvas(l.rasterizedImage),h=l.rasterizedImage.width,u=l.rasterizedImage.height,M=c-h*(.5+l.anchorX),I=d-u*(.5-l.anchorY);if(l.angle){const P=(360-l.angle)*Math.PI/180;s.save(),s.translate(p(l.offsetX),-p(l.offsetY)),s.translate(c,d),s.rotate(P),s.translate(-c,-d),s.drawImage(f,M,I),s.restore()}else s.drawImage(f,M+p(l.offsetX),I-p(l.offsetY))}const C=new B({x:c/t.width-.5,y:d/t.height-.5});return{imageData:t.width!==0&&t.height!==0?s.getImageData(0,0,t.width,t.height):s.createImageData(1,1),anchorPosition:C}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,s=t.getContext("2d");return t.width=e.width,t.height=e.height,s.putImageData(e,0,0),t}_imageTo32Array(e,t,s,a){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const r=this._imageDataCanvas,i=r.getContext("2d");if(r.width=t,r.height=s,i.drawImage(e,0,0,t,s),a){i.save();const o=new Q(a);i.fillStyle=o.toHex(),i.globalCompositeOperation="multiply",i.fillRect(0,0,t,s),i.globalCompositeOperation="destination-atop",i.drawImage(e,0,0,t,s),i.restore()}return new Uint32Array(i.getImageData(0,0,t,s).data.buffer)}_getRasterizedResource(e,t,s,a,r,i){let o,n,c,d,C=null,g=null;if(s==="esriGeometryPolyline"||s==="esriGeometryPolygon"){const f=a&&a.style?a.style:D.Legend,h=s==="esriGeometryPolyline"?U.stroke[f]:U.fill[f];if(e.type==="line"){if(e.cim.type!=="CIMSolidStroke"){if(e.cim.type==="CIMPictureStroke"){const u=y(e.width,t,r,i),M=y(e.color,t,r,i),{image:I,width:P,height:x}=this._getPictureResource(e,u,M);return this._rasterizePictureResource(e,I,P,x,h,u)}return null}({analyzedCIM:o,hash:c}=R(e,t,r,i)),n=this._embedCIMLayerInVectorMarker(o,h)}else if(e.type==="marker"){if(e.cim.type==="CIMPictureMarker"||e.cim.type!=="CIMVectorMarker")return null;e.cim.offsetX=y(e.offsetX,t,r,i),e.cim.offsetY=y(e.offsetY,t,r,i),e.cim.rotation=y(e.rotation,t,r,i),e.cim.markerPlacement=e.markerPlacement,{analyzedCIM:o}=R(e,t,r,i),c=Z(JSON.stringify(o)).toString(),n=this._embedCIMLayerInVectorMarker(o,h),C=y(e.size,t,r,i),g=e.path}else{if(e.type==="text")return null;if(e.type==="fill"){if(e.cim.type==="CIMHatchFill"||e.cim.type==="CIMVectorMarker"||e.cim.type==="CIMPictureMarker"||e.cim.type==="CIMPictureFill"){const u=e.cim.size||e.cim.height;let M,I,P;if(e.cim.type==="CIMPictureMarker"||e.cim.type==="CIMPictureFill")({image:M,width:I,height:P}=this._getPictureResource(e,u,y(e.color,t,r,i)));else{({analyzedCIM:o,hash:c}=R(e,t,r,i));const x=this._rasterizer.rasterizeJSONResource({cim:o,type:e.type,url:e.url,mosaicHash:c,size:u,path:g},1,this._avoidSDF);M=x.image,I=x.size[0],P=x.size[1]}return this._rasterizePictureResource(e,M,I,P,h,null)}if(e.cim.type!=="CIMSolidFill")return null;({analyzedCIM:o,hash:c}=R(e,t,r,i)),n=this._embedCIMLayerInVectorMarker(o,h)}}}else{if(e.type==="text")return d=this._rasterizeTextResource(e,t,a,r,i),d;({analyzedCIM:o,hash:c}=R(e,t,r,i));const f=A(a,e,null);if(e.cim.type==="CIMPictureMarker"){const h=y(e.size,t,r,i)*f,{image:u,width:M,height:I}=this._getPictureResource(e,h,y(e.color,t,r,i));return d={image:u,size:[M,I],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},d}$(o,f,{preserveOutlineWidth:!1}),n=o}c+=s,a&&(c+=JSON.stringify(a));const l=this._resourceCache;return l.has(c)?l.get(c):(d=this._rasterizer.rasterizeJSONResource({cim:n,type:e.type,url:e.url,mosaicHash:c,size:C,path:g},window.devicePixelRatio||1,this._avoidSDF),l.set(c,d),d)}_rasterizeTextResource(e,t,s,a,r){const i=A(s,e,null),o=y(e.text,t,a,r);if(!o||o.length===0)return null;const n=y(e.fontName,t,a,r),c=y(e.style,t,a,r),d=y(e.weight,t,a,r),C=y(e.decoration,t,a,r),g=y(e.size,t,a,r)*i,l=y(e.horizontalAlignment,t,a,r),f=y(e.verticalAlignment,t,a,r),h=V(y(e.color,t,a,r)),u=V(y(e.outlineColor,t,a,r)),M={color:h,size:g,horizontalAlignment:l,verticalAlignment:f,font:{family:n,style:c,weight:d,decoration:C},halo:{size:y(e.outlineSize,t,a,r)||0,color:u,style:c},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,M)}_rasterizePictureResource(e,t,s,a,r,i){const o=document.createElement("canvas"),n=o.getContext("2d");o.height=p(Math.max(r.frame.ymax-r.frame.ymin,i)),o.width=p(r.frame.xmax-r.frame.xmin);const c=n.createImageData(s,a);c.data.set(new Uint8ClampedArray(t.buffer));const d=this._imageDataToCanvas(c),C=n.createPattern(d,"repeat"),g=Math.cos((-e.cim.rotation||0)*Math.PI/180),l=Math.sin((-e.cim.rotation||0)*Math.PI/180);C.setTransform({m11:g,m12:l,m21:-l,m22:g,m41:p(e.cim.offsetX)||0,m42:p(e.cim.offsetY)||0});const f=r.canvasPaths;let h,u,M;J(f)?(h=f.rings,n.fillStyle=C,u=n.fill,M=["evenodd"]):ee(f)&&(h=f.paths,n.strokeStyle=C,n.lineWidth=i,u=n.stroke,h[0][0][1]=o.height/2,h[0][1][1]=o.height/2),n.beginPath();for(const x of h){const b=x?x.length:0;if(b>1){let z=x[0];n.moveTo(p(z[0]),p(z[1]));for(let w=1;w<b;++w)z=x[w],n.lineTo(p(z[0]),p(z[1]));n.closePath()}}u.apply(n,M);const I=n.getImageData(0,0,o.width,o.height),P=new Uint8Array(I.data);return{size:[o.width,o.height],image:new Uint32Array(P.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}_getPictureResource(e,t,s){const a=this._pictureMarkerCache.get(e.materialHash);if(!a)return null;const r=a.height/a.width,i=t?r>1?p(t):p(t)/r:a.width,o=t?r>1?p(t)*r:p(t):a.height;return{image:this._imageTo32Array(a,i,o,s),width:i,height:o}}_embedCIMLayerInVectorMarker(e,t){const s=J(t.geometry)?"CIMPolygonSymbol":"CIMLineSymbol",a=t.frame;return{type:"CIMVectorMarker",frame:a,size:a.ymax-a.ymin,markerGraphics:[{type:"CIMMarkerGraphic",geometry:t.geometry,symbol:{type:s,symbolLayers:[e]}}]}}}function ne(m){return(m?Object.keys(m):[]).map(e=>({name:e,alias:e,type:typeof m[e]=="string"?"esriFieldTypeString":"esriFieldTypeDouble"}))}function oe(m){if(!(m&&m.data&&m.data.symbol))return null;switch(m.data.symbol.type){case"CIMPointSymbol":case"CIMTextSymbol":return"esriGeometryPoint";case"CIMLineSymbol":return"esriGeometryPolyline";case"CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}function R(m,e,t,s){let a,r;return typeof m.materialHash=="function"?(a=(0,m.materialHash)(e,t,s),r=ae(m.cim,m.materialOverrides)):(a=m.materialHash,r=m.cim),{analyzedCIM:r,hash:a}}export{de as CIMSymbolRasterizer,D as GeometryStyle};
