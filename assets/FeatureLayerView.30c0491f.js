import{bF as A,aY as o,aZ as l,iT as j,gi as N,iU as G,a_ as C,bh as B,cz as b,gf as v,gg as x,iV as R,b1 as u,bd as M,iW as q,ct as Q,c7 as I,iX as _,iY as S,iZ as P,i_ as T,i$ as L,j0 as O,j1 as m,b6 as U,c5 as F,j2 as V}from"./vendor.47ccae81.js";import{d as g,t as z}from"./popupUtils.86aeb7da.js";const h=A.getLogger("esri.views.layers.FeatureLayerView"),Y=$=>{let n=class extends ${constructor(...t){super(...t),this._updatingRequiredFieldsPromise=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){B(this,["layer.renderer","layer.labelingInfo","layer.elevationInfo.featureExpressionInfo","layer.displayField","filter","featureEffect","layer.timeInfo","layer.floorInfo","timeExtent"],()=>this._handleRequiredFieldsChange(),!0),b(this,"view.floors","change",()=>this._handleRequiredFieldsChange()),b(this,"layer.sublayer","change",()=>this._handleRequiredFieldsChange())}get availableFields(){const{layer:t,layer:{fieldsIndex:e},requiredFields:r}=this;return"outFields"in t&&t.outFields?v(e,[...x(e,t.outFields),...r]):v(e,r)}set effect(t){R(h,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect=t}get effect(){return R(h,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(t){t!==void 0?this._override("featureEffect",t):this._clearOverride("featureEffect")}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(t){h.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(t){throw new Error("missing implementation")}createQuery(){const t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},e=u(this.filter)?this.filter.createQuery(t):new M(t);if(this.layer.type==="feature"){const r=q(this);u(r)&&(e.where=e.where?`(${e.where}) AND (${r})`:r)}return u(this.timeExtent)&&(e.timeExtent=u(e.timeExtent)?e.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),e}queryFeatures(t,e){throw new Error("missing implementation")}queryObjectIds(t,e){throw new Error("missing implementation")}queryFeatureCount(t,e){throw new Error("missing implementation")}queryExtent(t,e){throw new Error("missing implementation")}async fetchPopupFeatures(t,e){const r=this.validateFetchPopupFeatures(e);if(r)throw r;return this.fetchClientPopupFeatures(e)}_loadArcadeModules(t){if(t.get("expressionInfos.length")||Array.isArray(t.content)&&t.content.some(e=>e.type==="expression"))return Q()}_handleRequiredFieldsChange(){const t=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",t),t.then(()=>{this._updatingRequiredFieldsPromise===t&&this._set("_updatingRequiredFieldsPromise",null)})}async _updateRequiredFields(){if(!this.layer||!this.view)return;const t=this.view.type==="3d",{layer:e,layer:{fieldsIndex:r,objectIdField:f}}=this,p="renderer"in e&&e.renderer,s="orderBy"in e&&e.orderBy,a=e.featureReduction,i=new Set,y=await I([p?p.collectRequiredFields(i,r):null,_(i,e),t?S(i,e):null,u(this.filter)?P(i,e,this.filter):null,u(this.featureEffect)?P(i,e,this.featureEffect.filter):null,a?T(i,e,a):null,s?L(i,e,s):null]);if(e.timeInfo&&this.timeExtent&&O(i,e.fieldsIndex,[e.timeInfo.startField,e.timeInfo.endField]),e.type==="feature"&&e.floorInfo&&O(i,e.fieldsIndex,[e.floorInfo.floorField]),e.type==="subtype-group"){m(i,r,e.subtypeField);const d=e.sublayers.map(w=>{var E;return Promise.all([(E=w.renderer)==null?void 0:E.collectRequiredFields(i,r),_(i,w)])});await I(d)}for(const d of y)d.error&&h.error(d.error);m(i,r,f),t&&"displayField"in e&&e.displayField&&m(i,r,e.displayField);const c=Array.from(i).sort();this._set("requiredFields",c)}validateFetchPopupFeatures(t){if(U(t))return null;for(const e of t.clientGraphics){const r=e.layer;if("popupEnabled"in r&&!r.popupEnabled)return new F("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:r});if("popupTemplate"in r&&!g(r,t))return new F("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:r});if(e.isAggregate&&!(r.featureReduction&&"popupTemplate"in r.featureReduction&&r.featureReduction.popupEnabled&&r.featureReduction.popupTemplate))return new F("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:r})}}async fetchClientPopupFeatures(t){const e=u(t)?t.clientGraphics:null;if(!e||e.length===0)return[];const r=new Array(e.length),f=new Map,p=await this.createPopupQuery(t);for(let s=0;s<e.length;s++){const a=e[s];if(a.isAggregate){r[s]=a;continue}const{layer:i}=a;if(!("popupEnabled"in i))continue;const y=x(this.layer.fieldsIndex,p.outFields),c=g(i,t);if(!u(c))continue;const d=await this._loadArcadeModules(c);d&&d.arcadeUtils.hasGeometryOperations(c)||!V(y,a)?f.set(a.getObjectId(),s):r[s]=a}if(this.layer.type==="stream"||f.size===0)return r.filter(Boolean);p.objectIds=Array.from(f.keys());try{const s=await this.layer.queryFeatures(p);for(const a of s.features)r[f.get(a.getObjectId())]=a}catch{}return r.filter(Boolean)}async createPopupQuery(t){const e=this.layer.createQuery(),r=new Set;let f=!1;const p=u(t)&&t.clientGraphics?t.clientGraphics.map(s=>s.layer):[this.layer];for(const s of p){if(!("popupEnabled"in s))continue;const a=g(s,t);if(!u(a))continue;const i=await this._loadArcadeModules(a),y=i&&i.arcadeUtils.hasGeometryOperations(a);f=!(this.layer.geometryType!=="point"&&!y);const c=await z(this.layer,a);for(const d of c)r.add(d)}if(e.returnGeometry=f,e.returnZ=f,e.returnM=f,e.outFields=Array.from(r),e.outSpatialReference=this.view.spatialReference,this.layer.type==="feature"){const s=q(this);u(s)&&(e.where=e.where?`(${e.where}) AND (${s})`:s)}return e}canResume(){return!!super.canResume()&&(!u(this.timeExtent)||!this.timeExtent.isEmpty)}};return o([l()],n.prototype,"_updatingRequiredFieldsPromise",void 0),o([l({readOnly:!0})],n.prototype,"availableFields",null),o([l()],n.prototype,"effect",null),o([l({type:j})],n.prototype,"featureEffect",null),o([l({type:N})],n.prototype,"filter",void 0),o([l(G)],n.prototype,"timeExtent",void 0),o([l()],n.prototype,"layer",void 0),o([l({type:Number})],n.prototype,"maximumNumberOfFeatures",null),o([l({readOnly:!0,type:Boolean})],n.prototype,"maximumNumberOfFeaturesExceeded",null),o([l({readOnly:!0})],n.prototype,"requiredFields",void 0),o([l()],n.prototype,"suspended",void 0),o([l()],n.prototype,"view",void 0),n=o([C("esri.views.layers.FeatureLayerView")],n),n};export{Y as O};
