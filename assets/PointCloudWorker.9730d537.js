import{eL as v,r as b,fB as A,cn as m,aT as S,cB as j,e$ as y,f1 as D,hX as h}from"./index.988b09cd.js";import{c as M,a as c,u as g,m as x}from"./PointCloudWorkerUtil.5b8032e0.js";import"./vendor.c6be4c00.js";import"./index.25aa0880.js";/* empty css              */import"./qrcode.0911187d.js";/* empty css                 */import"./PointCloudUniqueValueRenderer.1a9fd5ff.js";import"./I3SBinaryReader.5e4e1dc7.js";class w{transform(t){const r=this._transform(t),e=[r.points.buffer,r.rgb.buffer];b(r.pointIdFilterMap)&&e.push(r.pointIdFilterMap.buffer);for(const a of r.attributes)"buffer"in a.values&&A(a.values.buffer)&&a.values.buffer!==r.rgb.buffer&&e.push(a.values.buffer);return Promise.resolve({result:r,transferList:e})}_transform(t){const r=M(t.schema,t.geometryBuffer);let e=r.length/3,a=null;const s=[],f=c(t.primaryAttributeData,r,e);b(t.primaryAttributeData)&&f&&s.push({attributeInfo:t.primaryAttributeData.attributeInfo,values:f});const n=c(t.modulationAttributeData,r,e);b(t.modulationAttributeData)&&n&&s.push({attributeInfo:t.modulationAttributeData.attributeInfo,values:n});let i=g(t.rendererInfo,f,n,e);if(t.filterInfo&&t.filterInfo.length>0&&b(t.filterAttributesData)){const o=t.filterAttributesData.map(l=>{const I=c(l,r,e),p={attributeInfo:l.attributeInfo,values:I};return s.push(p),p});a=new Uint32Array(e),e=x(r,i,a,t.filterInfo,o)}for(const o of t.userAttributesData){const l=c(o,r,e);s.push({attributeInfo:o.attributeInfo,values:l})}3*e<i.length&&(i=new Uint8Array(i.buffer.slice(0,3*e))),this._applyElevationOffsetInPlace(r,e,t.elevationOffset);const u=this._transformCoordinates(r,e,t.obb,m.fromJSON(t.inSR),m.fromJSON(t.outSR));return{obb:t.obb,points:u,rgb:i,attributes:s,pointIdFilterMap:a}}_transformCoordinates(t,r,e,a,s){if(!S(t,a,0,t,s,0,r))throw Error("Can't reproject");const f=j(e.center[0],e.center[1],e.center[2]),n=h(),i=h();y(d,e.quaternion);const u=new Float32Array(3*r);for(let o=0;o<r;o++)n[0]=t[3*o]-f[0],n[1]=t[3*o+1]-f[1],n[2]=t[3*o+2]-f[2],D(i,n,d),e.halfSize[0]=Math.max(e.halfSize[0],Math.abs(i[0])),e.halfSize[1]=Math.max(e.halfSize[1],Math.abs(i[1])),e.halfSize[2]=Math.max(e.halfSize[2],Math.abs(i[2])),u[3*o]=n[0],u[3*o+1]=n[1],u[3*o+2]=n[2];return u}_applyElevationOffsetInPlace(t,r,e){if(e!==0)for(let a=0;a<r;a++)t[3*a+2]+=e}}const d=v();function q(){return new w}export{q as default};
