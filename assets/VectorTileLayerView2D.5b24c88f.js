var G=Object.defineProperty,W=Object.defineProperties;var Z=Object.getOwnPropertyDescriptors;var V=Object.getOwnPropertySymbols;var J=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable;var $=(i,e,t)=>e in i?G(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,H=(i,e)=>{for(var t in e||(e={}))J.call(e,t)&&$(i,t,e[t]);if(V)for(var t of V(e))K.call(e,t)&&$(i,t,e[t]);return i},P=(i,e)=>W(i,Z(e));import{d8 as X,c_ as m,mA as q,t as R,r as y,J as Y,iv as ee,iw as te,mG as se,dH as ie,dV as re,bu as M,aI as le,d4 as ae,aP as L,mj as oe,iB as ne,X as he,eg as ce,an as de,q as ue,h as ye,m as _e,mb as pe,g as F,mu as Q,cD as fe,ix as me,e as w,d as I,i as ge}from"./index.a1c5dd56.js";import{r as ve,i as be,a as Te,u as Ce,o as we}from"./SymbolRepository.9331d21c.js";import{I as g}from"./Utils.bc20347e.js";import{o as Se}from"./TileContainer.ffa9f91c.js";import{a as U}from"./StyleRepository.c74906f2.js";import{l as Re}from"./LayerView2D.762cd08a.js";import{g as Ie}from"./Bitmap.0398012e.js";import{t as De}from"./BitmapContainer.91bf8c40.js";import"./vendor.c6be4c00.js";import"./index.a0863940.js";/* empty css              */import"./qrcode.0911187d.js";/* empty css                 */import"./BidiEngine.aae60613.js";import"./CIMSymbolHelper.a880d9c5.js";import"./definitions.21e97413.js";import"./number.dfbabd3f.js";import"./GeometryUtils.d4e26b77.js";import"./WGLContainer.3b2fd5d0.js";import"./brushes.72191f86.js";import"./programUtils.44a18329.js";import"./GeometryUtils.ea8c8742.js";import"./MaterialKey.89cee420.js";import"./pixelUtils.41f8268c.js";import"./Container.d3a75275.js";import"./EffectView.1278bb79.js";import"./colorUtils.92e1b957.js";const j=512,xe=1e-6,He=(i,e)=>i+1/(1<<2*e);class Pe{constructor(e,t){this._tiles=new Map,this._tileCache=new X(40,s=>s.dispose()),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this._container=t}destroy(){for(const[e,t]of this._tiles)t.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null}update(e){this._updateCacheSize(e);const t=this.tileInfoView,s=t.getTileCoverage(e.state,0,"smallest"),{spans:r,lodInfo:l}=s,{level:o}=l,a=this._tiles,n=new Set,h=new Set;for(const{row:c,colFrom:d,colTo:C}of r)for(let p=d;p<=C;p++){const f=m.getId(o,c,l.normalizeCol(p),l.getWorldForColumn(p)),u=this._getOrAcquireTile(f);n.add(f),u.processed()?this._addToContainer(u):h.add(new m(f))}for(const[c,d]of a)d.isCoverage=n.has(c);for(const c of h)this._findPlaceholdersForMissingTiles(c,n);let S=!1;for(const[c,d]of a)d.neededForCoverage=n.has(c),d.neededForCoverage||d.isHoldingForFade&&t.intersects(s,d.key)&&n.add(c),d.isFading&&(S=!0);for(const[c,d]of this._tiles)n.has(c)||this._releaseTile(c);return q.pool.release(s),!S}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}_findPlaceholdersForMissingTiles(e,t){const s=[];for(const[l,o]of this._tiles)this._addPlaceholderChild(s,o,e,t);const r=s.reduce(He,0);Math.abs(1-r)<xe||this._addPlaceholderParent(e.id,t)}_addPlaceholderChild(e,t,s,r){t.key.level<=s.level||!t.hasData()||ze(s,t.key)&&(this._addToContainer(t),r.add(t.id),e.push(t.key.level-s.level))}_addPlaceholderParent(e,t){const s=this._tiles;let r=e;for(;;){if(r=Le(r),!r||t.has(r))return;const l=s.get(r);if(l&&l.hasData())return this._addToContainer(l),void t.add(l.id)}}_getOrAcquireTile(e){let t=this._tiles.get(e);return t||(t=this._tileCache.pop(e),t||(t=this.acquireTile(new m(e))),this._tiles.set(e,t),t)}_releaseTile(e){const t=this._tiles.get(e);this.releaseTile(t),this._removeFromContainer(t),this._tiles.delete(e),t.hasData()?this._tileCache.put(e,t,1):t.dispose()}_addToContainer(e){let t;const s=[],r=this._container;if(r.contains(e))return;const l=this._visibleTiles;for(const[o,a]of l)this._canConnectDirectly(e,a)&&s.push(a),R(t)&&this._canConnectDirectly(a,e)&&(t=a);if(y(t)){for(const o of s)t.childrenTiles.delete(o),e.childrenTiles.add(o),o.parentTile=e;t.childrenTiles.add(e),e.parentTile=t}else for(const o of s)e.childrenTiles.add(o),o.parentTile=e;l.set(e.id,e),r.addChild(e)}_removeFromContainer(e){if(this._visibleTiles.delete(e.id),this._container.removeChild(e),y(e.parentTile)){e.parentTile.childrenTiles.delete(e);for(const t of e.childrenTiles)y(e.parentTile)&&e.parentTile.childrenTiles.add(t)}for(const t of e.childrenTiles)t.parentTile=e.parentTile;e.parentTile=null,e.childrenTiles.clear()}_canConnectDirectly(e,t){const s=e.key;let{level:r,row:l,col:o,world:a}=t.key;const n=this._visibleTiles;for(;r>0;){if(r--,l>>=1,o>>=1,s.level===r&&s.row===l&&s.col===o&&s.world===a)return!0;if(n.has(`${r}/${l}/${o}/${a}`))return!1}return!1}_updateCacheSize(e){const t=e.state.size;if(t[0]===this._viewSize[0]&&t[1]===this._viewSize[1])return;const s=Math.ceil(t[0]/j)+1,r=Math.ceil(t[1]/j)+1;this._viewSize[0]=t[0],this._viewSize[1]=t[1],this._tileCache.maxSize=5*s*r}}function Le(i){const[e,t,s,r]=i.split("/"),l=parseInt(e,10);return l===0?null:`${l-1}/${parseInt(t,10)>>1}/${parseInt(s,10)>>1}/${parseInt(r,10)}`}function ze(i,e){const t=e.level-i.level;return i.row===e.row>>t&&i.col===e.col>>t&&i.world===e.world}const ke=.5,E=1e-6;class Be extends Y{constructor(e,t){super(),this.styleRepository=e,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._completed=!1,this._symbolRepository=new ve(4096,t,()=>new ee),this._symbolDeclutterer=new be(t,this._symbolRepository,(s,r,l)=>new Te(s,r,l,this.styleRepository,this._zoom,this._viewState.rotation),(s,r)=>{s.allSymbolsFadingOut=!0,s.lastOpacityUpdate=r,te(s,r,!0),s.decluttered=!0,s.requestRender()},(s,r)=>this.styleRepository.getStyleLayerByUID(s.styleLayerUID).z-this.styleRepository.getStyleLayerByUID(r.styleLayerUID).z,s=>{const r=this.styleRepository.getStyleLayerByUID(s);if(this._zoom+E<r.minzoom||this._zoom-E>=r.maxzoom)return!1;const l=r.getLayoutProperty("visibility");return!l||l.getValue()!==1})}addTile(e){e.decluttered=!1,this._tileToHandle.set(e,e.on("symbols-changed",()=>{this._symbolRepository.add(e),this.restartDeclutter()})),this._symbolRepository.add(e),this.restartDeclutter()}removeTile(e){const t=this._tileToHandle.get(e);t&&(this._symbolRepository.removeTile(e),this.restartDeclutter(),t.remove(),this._tileToHandle.delete(e))}update(e,t){return this._zoom=e,this._viewState={scale:t.scale,rotation:t.rotation,center:[t.center[0],t.center[1]],size:[t.size[0],t.size[1]]},this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach(e=>e.remove()),this._tileToHandle.clear()}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(e){this._symbolRepository.deleteStyleLayers(e)}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(se),this._completed&&this._scheduleNotifyStable())}_scheduleNotifyStable(){y(this._stableNotificationHandle)&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout(()=>{this._stableNotificationHandle=null,this.emit("fade-complete")},(1+ke)*ie)}_notifyUnstable(){y(this._stableNotificationHandle)&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this.emit("fade-start")}}class Ve extends re{_createTransforms(){return{dvs:M(),tileMat3:M()}}}const D=1e-6;function A(i,e){if(i){const t=i.getLayoutProperty("visibility");if(!t||t.getValue()!==1&&(i.minzoom===void 0||i.minzoom<e+D)&&(i.maxzoom===void 0||i.maxzoom>=e-D))return!0}return!1}class $e extends Se{constructor(e){super(e),this._backgroundTiles=[],this._pointToCallbacks=new Map}destroy(){this.removeAllChildren(),this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null),y(this._symbolFader)&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[],this._pointToCallbacks.clear()}setStyleResources(e,t,s){if(this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=s,R(this._symbolFader)){const r=new Be(this._styleRepository,this.children);r.on("fade-start",()=>{this.emit("fade-start"),this.requestRender()}),r.on("fade-complete",()=>{this.emit("fade-complete"),this.requestRender()}),this._symbolFader=r}le(this._symbolFader).styleRepository=s}deleteStyleLayers(e){y(this._symbolFader)&&this._symbolFader.deleteStyleLayers(e)}async hitTest(e){const t=ae();return this._pointToCallbacks.set(e,t),this.requestRender(),t.promise}enterTileInvalidation(){for(const e of this.children)e.invalidating=!0}createRenderParams(e){return P(H({},super.createRenderParams(e)),{renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos})}doRender(e){!this.visible||e.drawPhase!==g.MAP&&e.drawPhase!==g.DEBUG||this._spriteMosaic===void 0||super.doRender(e)}addChild(e){return super.addChild(e),y(this._symbolFader)?this._symbolFader.addTile(e):e.decluttered=!0,this.requestRender(),e}removeChild(e){return y(this._symbolFader)&&this._symbolFader.removeTile(e),this.requestRender(),super.removeChild(e)}renderChildren(e){const{drawPhase:t}=e;if(t!==g.DEBUG){if(this._doRender(e),this._pointToCallbacks.size>0){e.drawPhase=g.HITTEST;const s=e.painter.effects.hittest;s.bind(e),this._doRender(e),s.draw(e,this._pointToCallbacks),s.unbind(e),e.drawPhase=t}}else super.renderChildren(e)}removeAllChildren(){for(let e=0;e<this.children.length;e++){const t=this.children[e];y(this._symbolFader)&&this._symbolFader.removeTile(t),t.dispose()}super.removeAllChildren()}getStencilTarget(){return this.children.filter(e=>e.neededForCoverage&&e.hasData())}restartDeclutter(){y(this._symbolFader)&&this._symbolFader.restartDeclutter()}_doRender(e){const{context:t}=e,s=this._styleRepository;if(!s)return;const r=s.layers;let l=!0;e.drawPhase===g.HITTEST&&(l=!1),s.backgroundBucketIds.length>0&&(e.renderPass="background",this._renderBackgroundLayers(e,s.backgroundBucketIds)),super.renderChildren(e),e.drawPhase===g.MAP&&this._fade(e.displayLevel,e.state);const o=this.children.filter(a=>a.visible&&a.hasData());if(!o||o.length===0)return t.bindVAO(),t.setStencilTestEnabled(!0),void t.setBlendingEnabled(!0);for(const a of o)a.triangleCount=0;t.setStencilWriteMask(0),t.setColorMask(!0,!0,!0,!0),t.setStencilOp(7680,7680,7681),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!1),t.setDepthTestEnabled(!0),t.setDepthWriteEnabled(!0),t.setDepthFunction(515),t.setClearDepth(1),t.clear(t.gl.DEPTH_BUFFER_BIT),e.renderPass="opaque";for(let a=r.length-1;a>=0;a--)this._renderStyleLayer(r[a],e,o);t.setDepthWriteEnabled(!1),t.setBlendingEnabled(l),t.setBlendFunctionSeparate(1,771,1,771),e.renderPass="translucent";for(let a=0;a<r.length;a++)this._renderStyleLayer(r[a],e,o);t.setDepthTestEnabled(!1),e.renderPass="symbol";for(let a=0;a<r.length;a++)this._renderStyleLayer(r[a],e,o);t.bindVAO(),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!0)}_fade(e,t){y(this._symbolFader)&&(this._symbolFader.update(e,t)||this.requestRender())}_renderStyleLayer(e,t,s){const{painter:r,renderPass:l}=t;if(e===void 0)return;const o=e.getLayoutProperty("visibility");if(o&&o.getValue()===1)return;let a;switch(e.type){case 0:return;case 1:if(l!=="opaque"&&t.renderPass!=="translucent")return;a="vtlFill";break;case 2:if(l!=="translucent")return;a="vtlLine";break;case 4:if(l!=="symbol")return;a="vtlCircle";break;case 3:if(l!=="symbol")return;a="vtlSymbol"}if(s=e.type===3?s.filter(h=>h.decluttered):s.filter(h=>h.neededForCoverage),a!=="vtlSymbol"){const h=t.displayLevel;if(s.length===0||e.minzoom!==void 0&&e.minzoom>=h+D||e.maxzoom!==void 0&&e.maxzoom<h-D)return}const n=e.uid;t.styleLayerUID=n,t.styleLayer=e;for(const h of s)if(h.layerData.has(n)){r.renderObjects(t,s,a);break}}_renderBackgroundLayers(e,t){const{context:s,displayLevel:r,painter:l,state:o}=e,a=this._styleRepository;let n=!1;for(const _ of t)if(a.getLayerById(_).type===0&&A(a.getLayerById(_),r)){n=!0;break}if(!n)return;const h=this._tileInfoView.getTileCoverage(e.state,0,"smallest"),{spans:S,lodInfo:c}=h,{level:d}=c,C=L(),p=[];if(this._renderPasses){const _=this._renderPasses[0];y(this._clippingInfos)&&(_.brushes[0].prepareState(e,this._clippingInfos[0]),_.brushes[0].drawMany(e,this._clippingInfos))}const f=this._backgroundTiles;let u,x=0;for(const{row:_,colFrom:b,colTo:N}of S)for(let T=b;T<=N;T++){if(x<f.length)u=f[x],u.key.set(d,_,c.normalizeCol(T),c.getWorldForColumn(T)),this._tileInfoView.getTileBounds(C,u.key,!1),u.x=C[0],u.y=C[3];else{const k=new m(d,_,c.normalizeCol(T),c.getWorldForColumn(T)),B=this._tileInfoView.getTileBounds(L(),k);u=new Ve(k,B[0],B[3],512,512,4096,4096),f.push(u)}u.setTransform(o,this._tileInfoView.getTileResolution(u.key)),p.push(u),x++}s.setStencilWriteMask(0),s.setColorMask(!0,!0,!0,!0),s.setStencilOp(7680,7680,7681),s.setStencilFunction(514,0,255);let z=!0;e.drawPhase===g.HITTEST&&(z=!1),s.setStencilTestEnabled(z);for(const _ of t){const b=a.getLayerById(_);b.type===0&&A(b,r)&&(e.styleLayerUID=b.uid,e.styleLayer=b,l.renderObjects(e,p,"vtlBackground"))}q.pool.release(h)}}class qe extends De{constructor(e){super(),this.requestRender=this.requestRender.bind(this),this._layerView=e,this._canvas=document.createElement("canvas"),this._context=this._canvas.getContext("2d"),this._bitmap=new Ie(null,"standard",!1),this.addChild(this._bitmap)}doRender(e){const t=e.state,s=this._createCustomRenderParams(e),r=this._canvas,l=this._bitmap,o=window.devicePixelRatio;r.width=t.size[0]*o,r.height=t.size[1]*o,l.resolution=t.resolution;const a=t.clone();a.pixelRatio=o,l.pixelRatio=o,s.state=a,l.x=t.viewpoint.targetGeometry.x-Math.abs(t.extent.xmax-t.extent.xmin)/2,l.y=t.viewpoint.targetGeometry.y+Math.abs(t.extent.ymax-t.extent.ymin)/2,this._layerView.render(s),l.source=r,l.rotation=t.rotation,super.doRender(P(H({},e),{state:a}))}_createCustomRenderParams(e){return{globalOpacity:e.globalOpacity,state:e.state,stationary:e.stationary,pixelRatio:window.devicePixelRatio,context:this._context}}}class Me extends oe{constructor(){super(...arguments),this._fullCacheLodInfos=null,this._levelByScale={}}getTileParentId(e){const t=m.pool.acquire(e),s=t.level===0?null:m.getId(t.level-1,t.row>>1,t.col>>1,t.world);return m.pool.release(t),s}getTileCoverage(e,t,s){const r=super.getTileCoverage(e,t,s);if(!r)return r;const l=1<<r.lodInfo.level;return r.spans=r.spans.filter(o=>o.row>=0&&o.row<l),r}scaleToLevel(e){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[e])return this._levelByScale[e];{const t=this._fullCacheLodInfos;if(e>t[0].scale)return t[0].level;let s,r;for(let l=0;l<t.length-1;l++)if(r=t[l+1],e>r.scale)return s=t[l],s.level+(s.scale-e)/(s.scale-r.scale);return t[t.length-1].level}}_initializeFullCacheLODs(e){let t;if(e[0].level===0)t=e.map(s=>({level:s.level,resolution:s.resolution,scale:s.scale}));else{const s=this.tileInfo.size[0],r=this.tileInfo.spatialReference;t=ne.create({size:s,spatialReference:r}).lods.map(l=>({level:l.level,resolution:l.resolution,scale:l.scale}))}for(let s=0;s<t.length;s++)this._levelByScale[t[s].scale]=t[s].level;this._fullCacheLodInfos=t}}const O=he.getLogger("esri.views.2d.layers.VectorTileLayerView2D");let v=class extends Re(ce){constructor(){super(...arguments),this._styleChanges=[],this._fetchQueue=null,this._parseQueue=null,this._isTileHandlerReady=!1,this.fading=!1}initialize(){const i=this.layer.tileInfo;if(!(i&&i.spatialReference).equals(this.view.spatialReference))return void this.addResolvingPromise(Promise.reject(new de("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer})));const{style:e}=this.layer.currentStyleInfo;this._styleRepository=new U(e),this._tileInfoView=new Me(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new $e(this._tileInfoView),this._tileHandler=new Ce(this.layer,this._styleRepository,window.devicePixelRatio||1),this.container.addChild(this._vectorTileContainer),this.handles.add([this._vectorTileContainer.on("fade-start",()=>{this.fading=!0,this.notifyChange("updating"),this.requestUpdate()}),this._vectorTileContainer.on("fade-complete",()=>{this._collisionBoxesDisplay&&this._collisionBoxesDisplay.requestRender(),this.fading=!1,this.notifyChange("updating"),this.requestUpdate()}),ue(this.layer,"symbolCollisionBoxesVisible",t=>{t?(this._collisionBoxesDisplay=new qe({render:s=>this._renderCollisionBoxes(s.context)}),this.container.addChild(this._collisionBoxesDisplay)):(this.container.removeChild(this._collisionBoxesDisplay),this._collisionBoxesDisplay=null)})])}destroy(){var i;this._stop(),this.container.removeAllChildren(),this._vectorTileContainer&&(this._vectorTileContainer.destroy(),this._vectorTileContainer=null),(i=this._tileHandler)==null||i.destroy(),this._tileHandler=null}async hitTest(i,e){if(!this._tileHandlerPromise)return null;await this._tileHandlerPromise;const t=await this._vectorTileContainer.hitTest(e);if(!t||t.length===0)return null;const s=t[0]-1,r=this._styleRepository,l=r.getStyleLayerByUID(s);if(!l)return null;const o=r.getStyleLayerIndex(l.id),a=new ye({attributes:{layerId:o,layerName:l.id,layerUID:s}});return a.layer=this.layer,a.sourceLayer=this.layer,[a]}update(i){if(this._tileHandlerPromise&&this._isTileHandlerReady)return i.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=i.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=i.state,this._parseQueue.state=i.state,this._tileManager.update(i)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()))}attach(){this._start(),this.handles.add([this.layer.on("paint-change",i=>{if(i.isDataDriven)this._styleChanges.push({type:0,data:i}),this.notifyChange("updating"),this.requestUpdate();else{const e=this._styleRepository,t=e.getLayerById(i.layer);if(!t)return;const s=t.type===3;e.setPaintProperties(i.layer,i.paint),s&&this._vectorTileContainer.restartDeclutter(),this._vectorTileContainer.requestRender()}}),this.layer.on("layout-change",i=>{const e=this._styleRepository,t=e.getLayerById(i.layer);if(!t)return;const s=_e(t.layout,i.layout);if(!R(s)){if(pe(s,"visibility")&&Fe(s)===1)return e.setLayoutProperties(i.layer,i.layout),t.type===3&&this._vectorTileContainer.restartDeclutter(),void this._vectorTileContainer.requestRender();this._styleChanges.push({type:1,data:i}),this.notifyChange("updating"),this.requestUpdate()}}),this.layer.on("style-layer-visibility-change",i=>{const e=this._styleRepository,t=e.getLayerById(i.layer);t&&(e.setStyleLayerVisibility(i.layer,i.visibility),t.type===3&&this._vectorTileContainer.restartDeclutter(),this._vectorTileContainer.requestRender())}),this.layer.on("style-layer-change",i=>{this._styleChanges.push({type:2,data:i}),this.notifyChange("updating"),this.requestUpdate()}),this.layer.on("delete-style-layer",i=>{this._styleChanges.push({type:3,data:i}),this.notifyChange("updating"),this.requestUpdate()}),this.layer.on("load-style",()=>this._loadStyle())],this.declaredClass)}detach(){this._stop(),this.handles.remove(this.declaredClass)}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this._collisionBoxesDisplay&&this._vectorTileContainer.restartDeclutter(),this.requestUpdate()}canResume(){let i=super.canResume();const e=this.layer;if(i&&e.currentStyleInfo){const t=this.view.scale,s=e.currentStyleInfo;if(s&&s.layerDefinition){const r=s.layerDefinition;r.minScale&&r.minScale<t&&(i=!1),r.maxScale&&r.maxScale>t&&(i=!1)}}return i}isUpdating(){const i=this._vectorTileContainer.children;return!this._isTileHandlerReady||!this._fetchQueue||!this._parseQueue||this._fetchQueue.updating||this._parseQueue.updating||i.length>0&&i.filter(e=>e.invalidating).length>0||this.fading}acquireTile(i){const e=this._createVectorTile(i);return this._tileHandlerPromise.then(()=>{this._fetchQueue.push(e.key).then(t=>this._parseQueue.push({key:e.key,data:t})).then(t=>{e.once("attach",()=>this.requestUpdate()),e.setData(t),this.requestUpdate(),this.notifyChange("updating")}).catch(t=>{this.notifyChange("updating"),F(t)||O.error(t)})}),e}releaseTile(i){const e=i.key.id;this._fetchQueue.abort(e),this._parseQueue.abort(e),this.requestUpdate()}_start(){if(this._stop(),this._tileManager=new Pe({acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;const i=new AbortController,e=this._tileHandler.start({signal:i.signal}).then(()=>{this._fetchQueue=new Q({tileInfoView:this._tileInfoView,process:(t,s)=>this._getTileData(t,s),concurrency:15}),this._parseQueue=new Q({tileInfoView:this._tileInfoView,process:(t,s)=>this._parseTileData(t,s),concurrency:8}),this.requestUpdate(),this._isTileHandlerReady=!0});this._tileHandler.spriteMosaic.then(t=>{this._vectorTileContainer.setStyleResources(t,this._tileHandler.glyphMosaic,this._styleRepository),this.requestUpdate()}),this._tileHandlerAbortController=i,this._tileHandlerPromise=e}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;const i=this._tileHandlerAbortController;i&&i.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue&&(this._fetchQueue.destroy(),this._fetchQueue=null),this._parseQueue&&(this._parseQueue.destroy(),this._parseQueue=null),this._tileManager&&(this._tileManager.destroy(),this._tileManager=null),this._vectorTileContainer.removeAllChildren()}async _getTileData(i,e){const t=await this._tileHandler.fetchTileData(i,e);return this.notifyChange("updating"),t}async _parseTileData(i,e){return this._tileHandler.parseTileData(i,e)}async _applyStyleChanges(){this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this._tileManager.clearCache();const i=this._styleChanges;try{await this._tileHandler.updateStyle(i)}catch(o){O.error("error applying vector-tiles style update",o.message),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0}const e=this._styleRepository,t=[];i.forEach(o=>{if(o.type!==3)return;const a=o.data,n=e.getLayerById(a.layer);n&&t.push(n.uid)});const s=[];let r;i.forEach(o=>{const a=o.type,n=o.data;switch(a){case 0:e.setPaintProperties(n.layer,n.paint),r=n.layer;break;case 1:e.setLayoutProperties(n.layer,n.layout),r=n.layer;break;case 3:return void e.deleteStyleLayer(n.layer);case 2:e.setStyleLayer(n.layer,n.index),r=n.layer.id}const h=e.getLayerById(r);h&&s.push(h.uid)});const l=this._vectorTileContainer.children;if(t.length>0){this._vectorTileContainer.deleteStyleLayers(t);for(const o of l)o.deleteLayerData(t)}if(this._fetchQueue.resume(),this._parseQueue.resume(),s.length>0){const o=[];for(const a of l){const n=this._fetchQueue.push(a.key).then(h=>this._parseQueue.push({key:a.key,data:h,styleLayerUIDs:s})).then(h=>a.setData(h));o.push(n)}await Promise.all(o)}this._styleChanges=[],this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate()}async _loadStyle(){const{style:i}=this.layer.currentStyleInfo,e=fe(i);this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this.notifyChange("updating"),this._styleRepository=new U(e),this._vectorTileContainer.destroy(),this._tileManager.clear(),this._tileHandlerAbortController.abort(),this._tileHandlerAbortController=new AbortController;const{signal:t}=this._tileHandlerAbortController;try{this._tileHandlerPromise=this._tileHandler.setStyle(this._styleRepository,e),await this._tileHandlerPromise}catch(r){if(!F(r))throw r}if(t.aborted)return this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),void this.requestUpdate();const s=await this._tileHandler.spriteMosaic;this._vectorTileContainer.setStyleResources(s,this._tileHandler.glyphMosaic,this._styleRepository),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate()}_createVectorTile(i){const e=this._tileInfoView.getTileBounds(L(),i);return new me(i,e[0],e[3],512,512,this._styleRepository)}_renderCollisionBoxes(i){for(const e of this._vectorTileContainer.children)if(e.symbols){const t=[];for(const[s,r]of e.symbols)t.push(...r);we(i,t)}}};function Fe(i){if(R(i))return 0;switch(i.type){case"partial":return Object.keys(i.diff).length;case"complete":return Math.max(Object.keys(i.oldValue).length,Object.keys(i.newValue).length);case"collection":return Object.keys(i.added).length+Object.keys(i.changed).length+Object.keys(i.removed).length}}w([I()],v.prototype,"_fetchQueue",void 0),w([I()],v.prototype,"_parseQueue",void 0),w([I()],v.prototype,"_isTileHandlerReady",void 0),w([I()],v.prototype,"fading",void 0),v=w([ge("esri.views.2d.layers.VectorTileLayerView2D")],v);const _t=v;export{_t as default};
