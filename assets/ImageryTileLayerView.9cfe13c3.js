import{e as u,d as f,hb as P,i as F,an as d,r as V,h as I,t as N}from"./index.988b09cd.js";import{w as j,j as R}from"./rasterProjectionHelper.d38d1723.js";import{d as S}from"./popupUtils.54225bd2.js";const D=_=>{let l=class extends _{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.view=null,this.fullExtent=null,this.tileInfo=null,this.datumTransformation=null}get hasTilingEffects(){return this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment}async fetchPopupFeatures(e,r){const{layer:t}=this;if(!e)return Promise.reject(new d("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:t}));const{popupEnabled:a}=t,i=S(t,r);if(!a||!V(i))throw new d("imageryTileLayerView:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:a,popupTemplate:i});const s=[],{value:n,magdirValue:h}=await t.identify(e,{timeExtent:this.timeExtent});let g="";if(n&&n.length){var w,b;g=t.type==="imagery-tile"&&t.hasStandardTime()&&n[0]!=null?n.map(c=>t.getStandardTimeValue(c)).join(", "):n.join(", ");const m={ObjectId:0},x="Raster.ServicePixelValue";m[x]=this._formatAttributeValue(g,x);const v=(w=t.rasterInfo)==null||(b=w.attributeTable)==null?void 0:b.features;if(v&&v.length>0){const c=v.filter(o=>{const p=o.attributes.value||o.attributes.Value||o.attributes.VALUE;return String(p)===g});if(c.length>0){const o=c[0];if(o){for(const p in o.attributes)if(o.attributes.hasOwnProperty(p)){const E=this._rasterFieldPrefix+p;m[E]=this._formatAttributeValue(o.attributes[p],E)}}}}const T=t.rasterInfo.dataType;T!=="vector-magdir"&&T!=="vector-uv"||(m["Raster.Magnitude"]=h==null?void 0:h[0],m["Raster.Direction"]=h==null?void 0:h[1]);const y=new I(this.fullExtent.clone(),null,m);y.layer=t,y.sourceLayer=y.layer,s.push(y)}return s}updateFullExtent(){const e=this.layer.tileInfo;if(!(e&&e.spatialReference))return Promise.reject(new d("layerview:tiling-information-missing","The layer doesn't provide tiling information",{layer:this.layer}));if(N(this.layer.fullExtent))return Promise.reject(new d("layerview:extent-missing","The layer doesn't provide a full extent.",{layer:this.layer}));const r=j(this.layer.fullExtent,this.view.spatialReference,!1),t=R(this.layer.fullExtent,this.view.spatialReference,r);return t==null?Promise.reject(new d("layerview:projection-not-supported","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})):(this._set("fullExtent",t),this.datumTransformation||(this.datumTransformation=j(this.layer.fullExtent,this.view.spatialReference,!0)),Promise.resolve())}_formatAttributeValue(e,r){if(typeof e=="string"){const t=this.layer.popupTemplate&&this.layer.popupTemplate.fieldInfos,a=this._getFieldInfo(t,r),i=a&&a.format;if(i){let s,n;return e.trim().indexOf(",")>-1?(s=",",n=s+" ",this._formatDelimitedString(e,s,n,i)):e.trim().indexOf(" ")>-1?(s=n=" ",this._formatDelimitedString(e,s,n,i)):this._formatNumberFromString(e,i)}}return e}_getFieldInfo(e,r){if(!e||!e.length||!r)return;const t=r.toLowerCase();let a;return e.some(i=>!(!i.fieldName||i.fieldName.toLowerCase()!==t&&i.fieldName.toLowerCase()!==t.replace(/ /g,"_"))&&(a=i,!0)),a}_formatDelimitedString(e,r,t,a){return e&&r&&t&&a?e.trim().split(r).map(i=>this._formatNumberFromString(i,a)).join(t):e}_formatNumberFromString(e,r){if(!e||!r)return e;const t=Number(e);return isNaN(t)?e:r.format(t)}};return u([f()],l.prototype,"layer",void 0),u([f(P)],l.prototype,"timeExtent",void 0),u([f()],l.prototype,"view",void 0),u([f()],l.prototype,"fullExtent",void 0),u([f()],l.prototype,"tileInfo",void 0),u([f({readOnly:!0})],l.prototype,"hasTilingEffects",null),l=u([F("esri.views.layers.ImageryTileLayerView")],l),l};export{D as m};
