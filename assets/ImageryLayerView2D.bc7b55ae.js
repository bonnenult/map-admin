import{X as E,e as s,d as n,fh as P,i as f,p as D,mC as G,el as O,a8 as S,r as j,g as C,h as I,bb as T,q as _,hr as z,eg as L}from"./index.988b09cd.js";import{p as A}from"./AnimatedFlowView2D.ee0129e1.js";import{l as H}from"./LayerView2D.8eaa8439.js";import{j as J}from"./rasterProjectionHelper.d38d1723.js";import{m as N}from"./dataUtils.5926a4d7.js";import{s as k}from"./Container.b0eab594.js";import{i as W}from"./GraphicContainer.f5d6e760.js";import{i as K}from"./BaseGraphicContainer.c36cfb1f.js";import{d as X}from"./pixelUtils.5acf42e1.js";import{t as Q}from"./BitmapContainer.f778b4a7.js";import{i as Y}from"./Bitmap.7e32071f.js";import{S as Z}from"./ExportStrategy.41ff6b2c.js";import{u as ee}from"./ImageryLayerView.b93b40bd.js";import{i as te}from"./RefreshableLayerView.c8d2ecf1.js";import"./vendor.c6be4c00.js";import"./index.25aa0880.js";/* empty css              */import"./qrcode.0911187d.js";/* empty css                 */import"./brushes.0945eb3a.js";import"./definitions.21e97413.js";import"./Utils.56a5b8e8.js";import"./number.dfbabd3f.js";import"./programUtils.cffd2d5b.js";import"./GeometryUtils.ea8c8742.js";import"./MaterialKey.d5a4d0f6.js";import"./WGLContainer.c4152aca.js";import"./EffectView.8c4917f2.js";import"./CIMSymbolHelper.2f431254.js";import"./BidiEngine.aae60613.js";import"./GeometryUtils.d4e26b77.js";import"./normalizeUtilsSync.76485664.js";import"./projectionSupport.0aea5e60.js";import"./json.2d0d6862.js";import"./FeatureContainer.840ef524.js";import"./visualVariablesUtils.2eb282ca.js";import"./visualVariablesUtils.08738833.js";import"./TileContainer.d9e05cad.js";import"./Matcher.a5267c34.js";import"./tileUtils.78233d4a.js";import"./TileClipper.1bed009a.js";import"./cimAnalyzer.644bcc6c.js";import"./cimSymbolUtils.d7ac92e9.js";import"./schemaUtils.2a5bddac.js";import"./MD5.f9440c6b.js";import"./util.c823b0c8.js";import"./ComputedAttributeStorage.38434ee7.js";import"./FeatureSetReader.c688f927.js";import"./centroid.0322b186.js";import"./GraphicsView.de7a8100.js";import"./popupUtils.54225bd2.js";const ie=E.getLogger("esri.views.2d.layers.imagery.ImageryGraphicsView2D");let l=class extends D{constructor(){super(...arguments),this.attached=!1,this.container=new k,this.updateRequested=!1,this._graphicsView=null,this._projectFullExtentPromise=null,this._dataParameters={exportParametersVersion:0,extents:[],tileResolution:0,time:"",isOceanStyle:!1,isOceanographic:!1},this.type="Graphics",this._graphics=new G,this._updateGraphics=O(async(e,t)=>{if(!e.stationary)return;const i=e.state,a=new S({xmin:i.extent.xmin,ymin:i.extent.ymin,xmax:i.extent.xmax,ymax:i.extent.ymax,spatialReference:i.spatialReference}),[r,p]=e.state.size,h={};h.timeExtent=this.timeExtent,h.requestAsImageElement=!1,h.signal=t,this._projectFullExtentPromise==null&&(this._projectFullExtentPromise=this._getProjectedFullExtent(a.spatialReference));const m=this.layer.renderer.type==="vector-field"?this.layer.renderer.symbolTileSize:50,g=await this._projectFullExtentPromise,{extent:w,resolution:B,width:M,height:$}=N(a,r,p,m,g),V=await this.layer.fetchImage(w,M,$,h),d=this.layer.renderer;if(d.type==="vector-field"){const u=V.pixelData.pixelBlock,y=d.sizeVariables[0];!j(u)||y.minDataValue&&y.maxDataValue||(y.minDataValue=u.statistics[0].minValue,y.maxDataValue=u.statistics[0].maxValue),this._pixelData={extent:w,pixelBlock:u};const R=w.clone().normalize(),q={exportParametersVersion:this.layer.exportImageServiceParameters.version,extents:R,tileResolution:B,time:JSON.stringify(this.timeExtent||""),isOceanStyle:d.flowRepresentation==="flow-to",isOceanographic:d.style==="ocean-current-kn"||d.style==="ocean-current-m"},x=this._canReuseVectorFieldData(q)?this._dataParameters.extents:[],U=await d.getGraphicsFromPixelData(V.pixelData,this.layer.rasterInfo.dataType==="vector-uv",x);if(x.length){const F=this._graphics.items.filter(v=>j(v.geometry)&&x.some(b=>b.intersects(v.geometry))&&!R.some(b=>b.intersects(v.geometry)));this._graphics.removeMany(F),this._graphics.addMany(U)}else this._graphics.set("items",U);this._graphicsView.update(e),this._dataParameters=q}})}destroy(){this.attached&&(this.detach(),this.attached=!1),this.updateRequested=!1}get updating(){return!this.attached||this.isUpdating()}update(e){this._updateGraphics(e).catch(t=>{C(t)||ie.error(t)})}hitTest(e){return new I({attributes:{},geometry:e.clone(),layer:this.layer})}attach(){this._graphicsView=new K({view:this.view,graphics:this._graphics,requestUpdateCallback:()=>this.requestUpdate(),container:new W(this.view.featuresTilingScheme)}),this.attached=!0}detach(){this._graphics.destroy(),this._graphicsView.destroy(),this.container.removeChild(this._graphicsView.container),this._graphicsView=null}install(e){this.container.addChild(this._graphicsView.container),e.addChild(this.container)}uninstall(e){this.container.removeChild(this._graphicsView.container),e.removeChild(this.container)}isUpdating(){return this._graphicsView.updating||this.updateRequested}getPixelData(){return this.updating?null:this._pixelData}redraw(){}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}async _getProjectedFullExtent(e){try{return await J(this.layer.fullExtent,e)}catch{try{const i=(await T(this.layer.url,{query:{option:"footprints",outSR:e.wkid||JSON.stringify(e.toJSON()),f:"json"}})).data.featureCollection.layers[0].layerDefinition.extent;return i?S.fromJSON(i):null}catch{return null}}}_canReuseVectorFieldData(e){const t=this._dataParameters.exportParametersVersion===e.exportParametersVersion,i=this._dataParameters.time===e.time,a=Math.abs(this._dataParameters.tileResolution-e.tileResolution)/e.tileResolution<.01,r=this._dataParameters.extents.some(m=>e.extents.some(g=>m.intersects(g))),p=this._dataParameters.isOceanStyle===e.isOceanStyle,h=this._dataParameters.isOceanographic===e.isOceanographic;return t&&i&&a&&r&&p&&h}};s([n()],l.prototype,"attached",void 0),s([n()],l.prototype,"container",void 0),s([n()],l.prototype,"layer",void 0),s([n()],l.prototype,"timeExtent",void 0),s([n()],l.prototype,"view",void 0),s([n()],l.prototype,"updateRequested",void 0),s([n()],l.prototype,"updating",null),s([P({graphics:"Graphics"})],l.prototype,"type",void 0),l=s([f("esri.views.2d.layers.imagery.ImageryGraphicsView2D")],l);const se=l,ae=E.getLogger("esri.views.2d.layers.imagery.ImageryView2D");let o=class extends D{constructor(){super(...arguments),this.attached=!1,this.container=new k,this.updateRequested=!1,this.type="Imagery",this._bitmapView=null}destroy(){this.attached&&(this.detach(),this.attached=!1),this.updateRequested=!1}get updating(){return!this.attached||this.isUpdating()}update(e){this.strategy.update(e).catch(t=>{C(t)||ae.error(t)})}detach(){this.strategy.destroy(),this._bitmapView.removeAllChildren(),this.container.removeAllChildren()}hitTest(e){return new I({attributes:{},geometry:e.clone(),layer:this.layer})}attach(){const e=this.layer.version>=10,t=this.layer.version>=10.1?this.layer.imageMaxHeight:2048,i=this.layer.version>=10.1?this.layer.imageMaxWidth:2048;this._bitmapView=new Q,this.strategy=new Z({container:this._bitmapView,imageNormalizationSupported:e,imageMaxHeight:t,imageMaxWidth:i,fetchSource:this._fetchImage.bind(this),requestUpdate:()=>this.requestUpdate()}),this.attached=!0}install(e){this.container.addChild(this._bitmapView),e.addChild(this.container)}uninstall(e){this.container.removeChild(this._bitmapView),e.removeChild(this.container)}redraw(){this.strategy.updateExports(e=>{e.source instanceof HTMLImageElement?e.requestRender():this.layer.applyRenderer({pixelBlock:e.source.pixelBlock}).then(t=>{const i=e.source;i.pixelBlock=t.pixelBlock,i.filter=a=>this.layer.applyFilter(a),this.container.requestRender()})})}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}isUpdating(){return this.strategy.updating||this.updateRequested}getPixelData(){if(this.updating)return null;const e=this.strategy.bitmaps;if(e.length===1&&e[0].source)return{extent:e[0].source.extent,pixelBlock:e[0].source.originalPixelBlock};if(e.length>1){const t=this.view.extent,i=e.map(r=>r.source).filter(r=>r.extent&&r.extent.intersects(t)).map(r=>({extent:r.extent,pixelBlock:r.originalPixelBlock})),a=X(i,t);return j(a)?{extent:a.extent,pixelBlock:a.pixelBlock}:null}return null}_fetchImage(e,t,i,a){return(a=a||{}).timeExtent=this.timeExtent,a.requestAsImageElement=!0,this.layer.fetchImage(e,t,i,a).then(r=>r.imageElement?r.imageElement:this.layer.applyRenderer(r.pixelData,{signal:a.signal}).then(p=>{const h=new Y(p.pixelBlock,p.extent.clone(),r.pixelData.pixelBlock);return h.filter=m=>this.layer.applyFilter(m),h}))}};s([n()],o.prototype,"attached",void 0),s([n()],o.prototype,"container",void 0),s([n()],o.prototype,"layer",void 0),s([n()],o.prototype,"strategy",void 0),s([n()],o.prototype,"timeExtent",void 0),s([n()],o.prototype,"view",void 0),s([n()],o.prototype,"updateRequested",void 0),s([n()],o.prototype,"updating",null),s([P({imagery:"Imagery"})],o.prototype,"type",void 0),o=s([f("esri.views.2d.layers.imagery.ImageryView2D")],o);const re=o;let c=class extends ee(te(H(L))){constructor(){super(...arguments),this._exportImageVersion=-1}initialize(){this.handles.add([_(this,["layer.blendMode","layer.effects"],e=>{this.subview&&(this.subview.container.blendMode=e)},!0),_(this,"layer.effect",e=>{this.subview&&(this.subview.container.effect=e)},!0)])}get pixelData(){return this.updating?null:"getPixelData"in this.subview?this.subview.getPixelData():null}get updating(){return!!(!this.subview||"updating"in this.subview&&this.subview.updating)}async hitTest(e,t){return this.subview?"hitTest"in this.subview?[this.subview.hitTest(e)]:[]:null}update(e){var t;(t=this.subview)==null||t.update(e)}attach(){this.layer.increaseRasterJobHandlerUsage(),this._setSubView(),this.handles.add([_(this,"layer.exportImageServiceParameters.version",e=>{this._exportImageVersion!==e&&(this._exportImageVersion=e,this.requestUpdate())}),this.watch("timeExtent",()=>{"timeExtent"in this.subview&&(this.subview.timeExtent=this.timeExtent),this.requestUpdate()}),this.layer.on("redraw",()=>{"redraw"in this.subview?this.subview.redraw():this.subview.redrawOrRefetch()}),z(this.layer,"renderer",()=>this._setSubView())],"imagerylayerview-update")}detach(){this.layer.decreaseRasterJobHandlerUsage(),this.subview.destroy(),this.handles.remove("imagerylayerview-update"),this._exportImageVersion=-1}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}async doRefresh(){this.requestUpdate()}isUpdating(){return!this.subview||!this.suspended&&this.subview.updating}_setSubView(){var e,t;let i="Imagery";((e=this.layer.renderer)==null?void 0:e.type)==="vector-field"&&this.layer.format==="lerc"&&(i="Graphics");var a,r;((t=this.layer.renderer)==null?void 0:t.type)==="animated-flow"&&(i="Flow"),this.subview&&this.subview.type===i||((a=this.subview)==null||a.uninstall(this.container),(r=this.subview)==null||r.destroy(),this.subview=i==="Imagery"?new re({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):i==="Graphics"?new se({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):new A({layer:this.layer,layerView:this}),this.subview.attach(),this.subview.install(this.container),this.subview.container.blendMode=this.layer.blendMode,this.subview.container.effect=this.layer.effect),this.requestUpdate()}};s([n()],c.prototype,"pixelData",null),s([n({readOnly:!0})],c.prototype,"updating",null),s([n()],c.prototype,"subview",void 0),c=s([f("esri.views.2d.layers.ImageryLayerView2D")],c);const st=c;export{st as default};
