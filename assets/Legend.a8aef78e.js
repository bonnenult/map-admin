var qt=Object.defineProperty;var Ge=Object.getOwnPropertySymbols;var Pt=Object.prototype.hasOwnProperty,Ht=Object.prototype.propertyIsEnumerable;var Qe=(e,t,s)=>t in e?qt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,O=(e,t)=>{for(var s in t||(t={}))Pt.call(t,s)&&Qe(e,s,t[s]);if(Ge)for(var s of Ge(t))Ht.call(t,s)&&Qe(e,s,t[s]);return e};import{dd as Ut,go as Se,rb as jt,rc as Wt,a as F,rd as Gt,q2 as Ke,q1 as Qt,mO as Xe,re as Je,oX as Ie,rf as Kt,X as Ye,d$ as Xt,nP as Ze,S as et,e as v,d as I,i as ae,p as tt,u as de,n as Ce,aS as ue,q as oe,mB as Jt,ap as K,el as Yt,mi as Zt,hr as k,aI as Ae,rg as W,iq as es,bb as st,rh as ts,ri as ss,rj as is,cL as ls,rk as rs,rl as ns,r as $e,rm as as,jo as os,rn as cs,l2 as d,ro as ye,q0 as Ee,p$ as ds,bk as P,l3 as Re,l0 as he,rp as us,l1 as xe,rq as pe,rr as H,ea as ys}from"./index.fe92decb.js";import{u as hs}from"./EffectView.873e2976.js";import{c as ps}from"./ExportImageParameters.676cd283.js";import{o as ms}from"./rendererConversion.3d1e3abc.js";import{l as fs,M as gs,A as bs,G as vs,j as _s,T as Ls,E as ws,V as it,D as Ss}from"./renderUtils.1b005f8d.js";import{getSymbolLayerFill as Is}from"./previewSymbol3D.dc48ffa9.js";import"./vendor.d9e807b5.js";import"./index.dbbecfd7.js";/* empty css              */import"./qrcode.0911187d.js";/* empty css                 */import"./colorUtils.92e1b957.js";import"./previewUtils.7b028938.js";import"./webStyleSymbolUtils.4a2c3915.js";const Cs=(e,t)=>{const s=e.featuresTilingScheme.getClosestInfoForScale(e.scale).level;return t!=null&&t.levels?t.levels[s]:null};function As(e,t){if(!e||!("visualVariables"in e)||!e.visualVariables)return null;const s=e.visualVariables.find(l=>l.type==="size"),i=Cs(t,s);return i?new Ut({field:s.field,minSize:i[2].size,minDataValue:i[2].value,maxSize:i[3].size,maxDataValue:i[3].value}):null}const $s=/^-?(\d+)(\.(\d+))?$/i;function Es(e,t){return e-t}function Rs(e,t){let s,i;return s=Number(e.toFixed(t)),s<e?i=s+1/10**t:(i=s,s-=1/10**t),s=Number(s.toFixed(t)),i=Number(i.toFixed(t)),[s,i]}function xs(e,t,s,i,l){const r=fe(e,t,s,i),n=r.previous==null||r.previous<=l,a=r.next==null||r.next<=l;return n&&a||r.previous+r.next<=2*l}function me(e){const t=String(e),s=t.match($s);if(s&&s[1])return{integer:s[1].split("").length,fractional:s[3]?s[3].split("").length:0};if(t.toLowerCase().indexOf("e")>-1){const i=t.split("e"),l=i[0],r=i[1];if(l&&r){const n=Number(l);let a=Number(r);const o=a>0;o||(a=Math.abs(a));const u=me(n);return o?(u.integer+=a,a>u.fractional?u.fractional=0:u.fractional-=a):(u.fractional+=a,a>u.integer?u.integer=1:u.integer-=a),u}}return{integer:0,fractional:0}}function fe(e,t,s,i){const l={previous:null,next:null};if(s!=null){const r=e-s,n=t-s-r;l.previous=Math.floor(Math.abs(100*n/r))}if(i!=null){const r=i-e,n=i-t-r;l.next=Math.floor(Math.abs(100*n/r))}return l}function Ve(e,t={}){const s=e.slice(0),{tolerance:i=2,strictBounds:l=!1,indexes:r=s.map((n,a)=>a)}=t;r.sort(Es);for(let n=0;n<r.length;n++){const a=r[n],o=s[a],u=a===0?null:s[a-1],c=a===s.length-1?null:s[a+1],h=me(o).fractional;if(h){let p,g=0,m=!1;for(;g<=h&&!m;){const _=Rs(o,g);p=l&&n===0?_[1]:_[0],m=xs(o,p,u,c,i),g++}m&&(s[a]=p)}}return s}const Vs={maximumFractionDigits:20};function zs(e){return Se(e,Vs)}const lt="<",rt=">",Ts=Wt("short-date");function nt(e,t,s,i){let l="";t===0?l=`${lt} `:t===s&&(l=`${rt} `);let r=null;return r=i?jt(e,Ts):zs(e),l+r}const ks=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwcdIkqhiWn5fHwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu6JrzFUAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwaeIkqhiWl5/HwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu6sKxboAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwadJEqhiWl5fPwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu75+IUcAAAAASUVORK5CYII="],Fs=new F([64,64,64]);function at(e,t){const s=[],i=e.length-1;return e.length===5?s.push(0,2,4):s.push(0,i),e.map((l,r)=>s.indexOf(r)>-1?nt(l,r,i,t):null)}async function ot(e,t,s){let i=!1,l=[],r=[];if(e.stops){const u=e.stops;l=u.map(c=>c.value),i=u.some(c=>!!c.label),i&&(r=u.map(c=>c.label))}const n=l[0],a=l[l.length-1];if(n==null&&a==null)return null;const o=i?null:at(l,s);return(await Promise.all(l.map(async(u,c)=>({value:u,color:e.type==="opacity"?await Ms(u,e,t):(await import("./index.fe92decb.js").then(function(h){return h.tt})).getColor(e,u),label:i?r[c]:o[c]})))).reverse()}async function Ms(e,t,s=Fs){const i=new F(s),l=(await import("./index.fe92decb.js").then(function(r){return r.tt})).getOpacity(t,e);return l!=null&&(i.a=l),i}function Bs(e){let t=!1,s=[],i=[];s=e.map(a=>a.value),t=e.some(a=>!!a.label),t&&(i=e.map(a=>a.label));const l=s[0],r=s[s.length-1];if(l==null&&r==null)return null;const n=t?null:at(s,!1);return s.map((a,o)=>({value:a,color:ct(a,e),label:t?i[o]:n[o]})).reverse()}function ct(e,t){const{startIndex:s,endIndex:i,weight:l}=Ns(e,t);if(s===i)return t[s].color;const r=F.blendColors(t[s].color,t[i].color,l);return new F(r)}function Ns(e,t){let s=0,i=t.length-1;return t.some((l,r)=>e<l.value?(i=r,!0):(s=r,!1)),{startIndex:s,endIndex:i,weight:(e-t[s].value)/(t[i].value-t[s].value)}}function Os(e,t){let s=[];if(e&&e.type==="multipart")e.colorRamps.reverse().forEach(function(i,l){l===0?s.push({value:t.max,color:new F(i.toColor),label:"high"}):s.push({value:null,color:new F(i.toColor),label:""}),l===e.colorRamps.length-1?s.push({value:t.min,color:new F(i.fromColor),label:"low"}):s.push({value:null,color:new F(i.fromColor),label:""})});else{let i,l;e&&e.type==="algorithmic"?(i=e.fromColor,l=e.toColor):(i=[0,0,0,1],l=[255,255,255,1]),s=[{value:t.max,color:new F(l),label:"high"},{value:t.min,color:new F(i),label:"low"}]}return s}function Ds(e){let t=e.colorStops,s=t.length-1;if(t&&t[0]){const i=t[s];i&&i.ratio!==1&&(t=t.slice(0),t.push(new Gt({ratio:1,color:i.color})),s++)}return t.map((i,l)=>{let r="";return l===0?r="low":l===s&&(r="high"),{color:i.color,label:r,ratio:i.ratio}}).reverse()}const dt={HH:315,HL:45,LL:135,LH:225},qs={2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]};function Ps(e){if(!e)return;const{type:t}=e;if(t.indexOf("3d")>-1)return Is(e.symbolLayers.getItemAt(0));if(t==="simple-line"){const s=Ke(e);return s&&s.color}if(e.type==="simple-marker"&&(e.style==="x"||e.style==="cross")){const s=Ke(e);return s&&s.color}return Qt(e)}function Hs(e,t){const s=t.HH.label,i=t.LL.label,l=t.HL.label,r=t.LH.label;switch(e){case"HH":default:return{top:s,bottom:i,left:l,right:r};case"HL":return{top:l,bottom:r,left:i,right:s};case"LL":return{top:i,bottom:s,left:r,right:l};case"LH":return{top:r,bottom:l,left:s,right:i}}}function Us(e){const{focus:t,infos:s,numClasses:i}=e,l=qs[i],r={};s.forEach(a=>{r[a.value]={label:a.label,fill:Ps(a.symbol)}});const n=[];for(let a=0;a<i;a++){const o=[];for(let u=0;u<i;u++){const c=r[l[a][u]];o.push(c.fill)}n.push(o)}return{type:"relationship-ramp",numClasses:i,focus:t,colors:n,labels:Hs(t,r),rotation:ut(t)}}function ut(e){let t=dt[e];return e&&t==null&&(t=dt.HH),t||0}const ze=30,Te=12,yt=[255,255,255],ht=[200,200,200],ge=[128,128,128],js=20,Ws=5;function Gs(e){return e.declaredClass==="esri.symbols.SimpleMarkerSymbol"}function Qs(e){return e.declaredClass==="esri.symbols.PictureMarkerSymbol"}function Ks(e){return e.declaredClass==="esri.symbols.SimpleLineSymbol"}function Xs(e){return e.declaredClass==="esri.symbols.TextSymbol"}function Js(e,t){const s=e.length-1;return e.map((i,l)=>nt(i,l,s,t))}async function Ys(e,t,s,i,l,r){var n,a;const o=t.legendOptions,u=o&&o.customValues,c=ti(e,s),h=!!c,p=!!u,g=t.minSize!=null&&t.maxSize!=null,m=t.stops&&t.stops.length>1,_=!!t.target;if(!h||!p&&!(g||m&&!_))return;const y=Ie(c);let S=null,b=null,C=null;b=y&&!m?Ve([t.minDataValue,t.maxDataValue]):u||await ii(t,c,i,l);const w=e==null?void 0:e.authoringInfo,A=(w==null?void 0:w.type)==="univariate-color-size",R=A&&(w==null?void 0:w.univariateTheme)==="above-and-below";if(!b&&m&&(b=t.stops.map(E=>E.value),S=t.stops.some(E=>!!E.label),S&&(C=t.stops.map(E=>E.label))),y&&((n=b)==null?void 0:n.length)>2&&!R&&(b=[b[0],b[b.length-1]]),!b)return null;A&&((a=b)==null?void 0:a.length)!==5&&(b=ft({minSize:b[0],maxSize:b[b.length-1]}));const T=y?Zs(e,b):null,j=Kt(c),N=S?null:Js(b,r);return(await Promise.all(b.map(async(E,q)=>{const D=y?T[q]:await X(t,c,E,i,l);return{value:E,symbol:ni(R&&e.type==="class-breaks"?ei(e,q):c,D),label:S?C[q]:N[q],size:D,outlineSize:j}}))).reverse()}function Zs(e,t){const s=e==null?void 0:e.authoringInfo,i=(s==null?void 0:s.type)==="univariate-color-size";let l=[Te,ze];if(i){const r=t[0],n=t[t.length-1],a=Te,o=ze;l=t.map(u=>a+(u-r)/(n-r)*(o-a))}return i&&(s==null?void 0:s.univariateTheme)==="below"&&l.reverse(),l}function ei(e,t){const s=e.classBreakInfos,i=s.length,l=i<2||!(t>=2)?s[0].symbol.clone():s[i-1].symbol.clone();return e.visualVariables.some(r=>r.type==="color")&&(l.type.indexOf("3d")>-1?pt(l):mt(l)),l}function ti(e,t){let s=null,i=null;if(e.type==="simple")s=e.symbol;else if(e.type==="class-breaks"){const l=e.classBreakInfos;s=l&&l[0]&&l[0].symbol,i=l.length>1}else if(e.type==="unique-value"){const l=e.uniqueValueInfos;s=l&&l[0]&&l[0].symbol,i=l.length>1}return!s||si(s)?null:(s=s.clone(),(t||i)&&(s.type.indexOf("3d")>-1?pt(s):mt(s)),s)}function si(e){return e?Xe(e)?!!e.symbolLayers&&e.symbolLayers.some(t=>t&&t.type==="fill"):e.type.indexOf("fill")!==-1:!1}function pt(e){e.type==="line-3d"?e.symbolLayers.forEach(t=>{t.material={color:ge}}):e.symbolLayers.forEach(t=>{t.type!=="icon"||t.resource&&t.resource.href?t.material={color:ht}:(t.material={color:yt},t.outline={color:ge,size:1.5})})}function mt(e){e.type==="cim"?Je(e,new F(ht)):e.type.indexOf("line")!==-1?e.color=ge:(e.color=yt,e.type==="simple-marker"&&(e.outline={color:ge,width:1.5}))}async function ii(e,t,s,i){const l=(await import("./index.fe92decb.js").then(function(a){return a.tt})).getSizeRangeAtScale(e,s,i),r=l&&ft(l);if(!l&&!r)return;let n=r.map(a=>li(a,e,l));n=Ve(n);for(let a=1;a<n.length-1;a++){const o=await ri(e,t,n[a],n[a-1],s,i);o&&(n[a]=o[0],r[a]=o[1])}return n}function ft(e){const t=e.minSize,s=e.maxSize,i=Ws,l=(s-t)/(i-1),r=[];for(let n=0;n<i;n++)r.push(t+l*n);return r}function li(e,t,s){const i=s.minSize,l=s.maxSize,r=t.minDataValue,n=t.maxDataValue;let a=null;return e<=i?a=r:e>=l?a=n:a=(e-i)/(l-i)*(n-r)+r,a}async function ri(e,t,s,i,l,r){const n=await X(e,t,s,l,r),a=await X(e,t,i,l,r),o=me(s),u=o.fractional,c=js;let h=o.integer,p=null,g=null;s>0&&s<1&&(p=10**u,h=me(s*=p).integer);for(let m=h-1;m>=0;m--){const _=10**m;let y=Math.floor(s/_)*_,S=Math.ceil(s/_)*_;p!=null&&(y/=p,S/=p);let b=(y+S)/2;[,b]=Ve([y,b,S],{indexes:[1]});const C=await X(e,t,y,l,r),w=await X(e,t,S,l,r),A=await X(e,t,b,l,r),R=fe(n,C,a,null),T=fe(n,w,a,null),j=fe(n,A,a,null);let N=R.previous<=c,E=T.previous<=c;if(N&&E&&(R.previous<=T.previous?(N=!0,E=!1):(E=!0,N=!1)),N?g=[y,C]:E?g=[S,w]:j.previous<=c&&(g=[b,A]),g)break}return g}async function X(e,t,s,i,l){const{getSize:r}=await import("./index.fe92decb.js").then(function(n){return n.tt});return r(e,s,{scale:i,view:l,shape:t.type==="simple-marker"?t.style:null})}function ni(e,t){const s=e.clone();if(Xe(s))Ie(s)||s.symbolLayers.forEach(i=>{i.type!=="fill"&&(i.size=t)});else if(Gs(s))s.size=t;else if(Qs(s)){const i=s.width,l=s.height;s.height=t,s.width=t*(i/l)}else Ks(s)?s.width=t:Xs(s)&&s.font&&(s.font.size=t);return s}Ye.getLogger("esri.renderers.support.utils");function ai(e){const t=2,s=Math.floor(Math.log10(Math.abs(e)))+1,i=s<4||s>6?4:s,l=1e6,r=Math.abs(e)>=l?"compact":"standard";return Se(e,{notation:r,minimumSignificantDigits:t,maximumSignificantDigits:i})}const U=Ye.getLogger("esri.widgets.Legend.support.ActiveLayerInfo"),oi="https://utility.arcgis.com/sharing/tools/legend",ci="esri.layers.ImageryLayer",di="esri.layers.ImageryTileLayer",ui="esri.layers.WCSLayer",be=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,yi=new Xt({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),gt={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34e38,34e38],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]},ve=new Ze({size:6,outline:{color:[128,128,128,.5],width:.5}}),hi=new et({style:"solid"});function bt(e){return e.type==="vector-field"}function vt(e){return e.type==="raster-colormap"}function _t(e){return e.type==="raster-stretch"}function Lt(e){return e.type==="raster-shaded-relief"}function J(e){return e.declaredClass==="esri.renderers.SimpleRenderer"}function Y(e){return e.declaredClass==="esri.renderers.ClassBreaksRenderer"}function ke(e){return e.declaredClass==="esri.renderers.UniqueValueRenderer"}function wt(e){return e.declaredClass==="esri.renderers.HeatmapRenderer"}function pi(e){return Fe(e)||Me(e)||Be(e)||mi(e)}function mi(e){return e.declaredClass==="esri.renderers.PointCloudRGBRenderer"}function Fe(e){return e.declaredClass==="esri.renderers.PointCloudClassBreaksRenderer"}function Me(e){return e.declaredClass==="esri.renderers.PointCloudStretchRenderer"}function Be(e){return e.declaredClass==="esri.renderers.PointCloudUniqueValueRenderer"}function St(e){return e.declaredClass==="esri.renderers.DotDensityRenderer"}function fi(e,t){return J(e)||Y(e)||ke(e)||wt(e)||St(e)?t.type==="2d"||ms(e):_t(e)||vt(e)||Lt(e)||Fe(e)||Me(e)||Be(e)||bt(e)}function It(e){return e.declaredClass==="esri.layers.BuildingSceneLayer"}function gi(e){return e.declaredClass==="esri.layers.VoxelLayer"}function bi(e){return e.declaredClass==="esri.layers.WMSLayer"}function vi(e){return e.declaredClass==="esri.layers.WMTSLayer"}function Ct(e){return e.declaredClass==="esri.layers.MapImageLayer"}function _i(e){return e.declaredClass==="esri.layers.TileLayer"}function Li(e){return e.declaredClass==="esri.layers.FeatureLayer"}function ce(e){return e.declaredClass===ci}function Ne(e){return e.declaredClass===di}function wi(e){return e.declaredClass===ui}function Si(e){return e.type==="stretch-ramp"}function Ii(e){const t="authoringInfo"in e&&(e==null?void 0:e.authoringInfo);return(t==null?void 0:t.type)==="univariate-color-size"}function Ci(e){const t="authoringInfo"in e&&(e==null?void 0:e.authoringInfo);return(t==null?void 0:t.type)==="univariate-color-size"&&(t==null?void 0:t.univariateTheme)==="above-and-below"}const Ai=new Ze({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let Z={},x=class extends tt{constructor(e){super(e),this._handles=new de,this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._webStyleSymbolCache=new Map,this._dotDensityUrlCache=new Map,this._scaleDrivenSizeVariable=null,this._hasClusterSizeVariable=!1,this.children=new Ce,this.layerView=null,this.layer=null,this.legendElements=[],this.parent=null,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.sublayerIds=[],this.title=null,this.view=null}initialize(){const e=()=>this.notifyChange("ready");this._handles.add([ue(this,"children","change",t=>{const{added:s,removed:i}=t,l=this._handles;s.forEach(r=>{const n=`activeLayerInfo-ready-watcher-${r.layer.uid}`;l.add(oe(r,"ready",e),n)}),i.forEach(r=>l.remove(r.layer.uid)),e()})]),this.keepCacheOnDestroy||(Z={})}destroy(){this._handles.destroy(),this._handles=null,this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(Z=null)}get effectList(){const e=this.layer;let t=null;return"effect"in e&&e.effect&&(t=new hs,t.effect=e.effect,t.end(),t.scale=this.scale),t}get opacity(){var e;const t=this.layer.opacity,s=(e=this.parent)==null?void 0:e.opacity,i=this.layer.parent,l=i&&"uid"in i?this._getParentLayerOpacity(i):null;return s!=null?s*t:l!=null?l*t:t}get ready(){return this.layer===null||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)}get scale(){return this.view&&this.view.scale}get isScaleDriven(){const e=this.layer;if(e===null)return!1;if("effect"in e&&e.effect&&Array.isArray(e.effect)||"featureReduction"in e&&e.featureReduction&&e.featureReduction.type==="cluster")return!0;if("renderer"in e&&e.renderer){if(e.renderer.type==="dot-density")return!0;const t=e.get("renderer.valueExpression");if(be.test(t))return!0;const s=e.get("renderer.visualVariables");if(s)return s.some(i=>this._isScaleDrivenSizeVariable(i))}return this._isLayerScaleDriven(this.layer)}get version(){return this._get("version")+1}async buildLegendElementsForFeatureCollections(e){if(!(!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView()))return this.legendElements=[],void this.notifyChange("ready");const t=Array.from(e,s=>{if(Li(s))return this._getRendererLegendElements(s.renderer,{title:s.title});if(s.featureSet&&s.featureSet.features.length){const i=s.layerDefinition,l=i&&i.drawingInfo,r=l&&Jt(l.renderer),n=yi.read(i.geometryType);return r?this._getRendererLegendElements(r,{title:s.name,geometryType:n}):(U.warn("drawingInfo not available!"),null)}return null});try{const s=[];await K(t).then(i=>{i.forEach(({value:l})=>l&&s.push(...l))}),this.legendElements=s,this.notifyChange("ready")}catch(s){U.warn("error while building legend for layer!",s)}}async buildLegendElementsForRenderer(e){try{const t=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView();this.legendElements=t?await this._getRendererLegendElements(e):[],this.notifyChange("ready")}catch(t){U.warn("error while building legend for layer!",t)}}async buildLegendElementsForTools(){const e=this.layer;if(gi(e))this._constructLegendElementsForVoxellayer();else if(vi(e))this._constructLegendElementsForWMTSlayer();else if(bi(e))await this._constructLegendElementsForWMSSublayers();else if(It(e))await this._constructLegendElementsForBuildingSceneLayer();else if(Ct(e)||_i(e)||It(e))await this._constructLegendElementsForSublayers();else{this._handles.remove("imageryLayers-watcher");let i="default";if(ce(e)){var t,s;const l=e;i=((l==null||(t=l.renderingRule)==null?void 0:t.functionName)||"default")+"_"+((s=e.bandIds)!=null&&s.length?e.bandIds.join(""):"###")}await this._getLegendLayers(`${e.uid}-${i}`).then(async l=>{this.legendElements=[],this.notifyChange("ready");const r=l.map(async n=>{if(ce(e)||Ne(e)){const o=e.watch(["renderingRule","bandIds"],()=>Yt(async()=>{Z.default=null,e.renderer?await this.buildLegendElementsForRenderer(e.renderer):await this.buildLegendElementsForTools()})());this._handles.add(o,"imageryLayers-watcher")}const a=this._generateSymbolTableElementForLegendLayer(n);a&&a.infos.length&&(ce(e)&&(a.title=e.title),this.legendElements.push(a)),this.notifyChange("ready")});await K(r)}).catch(l=>{U.warn("Request to server for legend has failed!",l)})}}async _isLayerInCurrentView(){const e=this.layer,t=this.layerView,s=t&&"createQuery"in t&&"queryFeatureCount"in t;if(!s&&!(t&&"createQuery"in e&&"queryFeatureCount"in e))return!0;await Zt(t,"updating");const i=s?"createQuery"in t&&t.createQuery():"createQuery"in e&&e.createQuery();return i.geometry=this.view.extent,(s?"queryFeatureCount"in t&&await t.queryFeatureCount(i):"queryFeatureCount"in e&&await e.queryFeatureCount(i))!==0}_getParentLayerOpacity(e){let t=1;const s=e.parent;return s&&"uid"in s&&(t=this._getParentLayerOpacity(s)),e.opacity*t}_isGroupActive(){const e=this.children;return!!e.length&&e.some(t=>t.ready)}_isScaleDrivenSizeVariable(e){if(e&&e.type!=="size")return!1;const t=e,s=t.minSize,i=t.maxSize;return typeof s=="object"&&s?this._isScaleDrivenSizeVariable(s):typeof i=="object"&&i?this._isScaleDrivenSizeVariable(i):!!t.expression||be.test(t.valueExpression)}_isLayerScaleDriven(e){if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some(s=>this._isLayerScaleDriven(s));const t=e.parent;if(e.loaded===!1&&t&&Ct(t)&&"source"in e&&e.source&&e.source.type==="map-layer"){for(const s of t.sourceJSON.layers)if(s.id===e.source.mapLayerId&&(s.minScale>0||s.maxScale>0))return!0}return!1}async _constructLegendElementsForVoxellayer(){this.legendElements=[],this._handles.remove("voxel-style-watcher");const e=this.layer;this._handles.add(k(e,"style",()=>this._constructLegendElementsForVoxellayer()),"voxel-style-watcher");const t=Ae(e.getVariableStyle(null)),s=[];var i;if(t){if((i=t.uniqueValues)!=null&&i.length){const n=[];t.uniqueValues.forEach(a=>{a.enabled&&n.push({label:a.label||`${a.value}`,value:a.value,symbol:new et({color:a.color,outline:null})})}),n.length&&s.push({type:"symbol-table",title:t.label,infos:n})}else if(t.transferFunction){const{colorStops:n,stretchRange:a}=t.transferFunction,o=n.toArray().reverse(),u=a.map((h,p)=>`${p===0?lt:rt} ${ai(h)}`).reverse(),c=o.map(h=>({color:h.color,value:null,label:null}));c[0].label=u[0],c[c.length-1].label=u[1],s.push({type:"color-ramp",title:t.label,infos:c,preview:W(o.map(h=>h.color))})}}const l=e.opacity,r=s.reduce((n,a)=>n.concat(this._getAllInfos(a)),[]).filter(n=>!(n==null||!n.symbol)).map(n=>this._getSymbolPreview(n,l));await K(r),this.legendElements=s,this.notifyChange("ready")}_constructLegendElementsForWMTSlayer(){this.legendElements=[],this._handles.remove("wmts-activeLayer-watcher");const e=this.layer.activeLayer;if(this._handles.add(k(this.layer,"activeLayer",()=>this._constructLegendElementsForWMTSlayer()),"wmts-activeLayer-watcher"),e.styleId&&e.styles){let t=null;e.styles.some(s=>e.styleId===s.id&&(t=s.legendUrl,!0)),t&&(this.legendElements=[{type:"symbol-table",title:e.title,infos:[{src:t,opacity:this.opacity}]}])}this.notifyChange("ready")}async _constructLegendElementsForWMSSublayers(){this.legendElements=[],this._handles.remove("wms-sublayers-watcher");const e=this.layer;let t=null;(e.customParameters||e.customLayerParameters)&&(t=O(O({},e.customParameters),e.customLayerParameters)),this._handles.add(k(this.layer,"sublayers",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher"),this.legendElements=await this._generateLegendElementsForWMSSublayers(e.sublayers,t),this.notifyChange("ready")}async _generateLegendElementsForWMSSublayers(e,t){const s=[];this._handles.add(e.on("change",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");const i=e.toArray();for(const l of i){const r=l.watch(["title","visible","legendEnabled"],()=>this._constructLegendElementsForWMSSublayers());if(this._handles.add(r,"wms-sublayers-watcher"),!this.respectLayerVisibility||l.visible&&l.legendEnabled){const n=await this._generateSymbolTableElementForWMSSublayer(l,t);n&&n.infos.length&&s.unshift(n)}}return s}async _generateSymbolTableElementForWMSSublayer(e,t){if(!e.legendUrl&&e.sublayers){const s=(await this._generateLegendElementsForWMSSublayers(e.sublayers,t)).filter(i=>i);return{type:"symbol-table",title:e.title,infos:s}}return this._generateSymbolTableElementForLegendUrl(e,t)}async _generateSymbolTableElementForLegendUrl(e,t){var s;let i=e.legendUrl;if(!i)return;const l={type:"symbol-table",title:e.title||e.name||e.id&&e.id+"",infos:[]};t&&(i=es(i,t));let r=null;const n=(s=e.layer)==null?void 0:s.opacity;try{r=(await st(i,{responseType:"image"})).data,r&&(r.style.opacity=n)}catch{}return l.infos.push({src:i,preview:r,opacity:n}),l}_getLegendLayers(e,t){const s=Z&&Z[e];return s?Promise.resolve(s):this._legendRequest(t).then(i=>{const l=i.layers;return Z[e]=l,l})}_legendRequest(e){const t=this.layer;let s={f:"json",dynamicLayers:e};if(ce(t)){const l=t.exportImageServiceParameters.renderingRule;if(l&&(s.renderingRule=JSON.stringify(l.toJSON())),t.bandIds&&(s.bandIds=t.bandIds.join()),t.raster||t.viewId||t.customParameters){const{raster:r,viewId:n,customParameters:a}=t;s=O(O({raster:r,viewId:n},s),a)}}let i=t.url.replace(/(\/)+$/,"");if("version"in t&&t.version>=10.01){const l=i.indexOf("?");l>-1?i=i.substring(0,l)+"/legend"+i.substring(l):i+="/legend"}else{const l=i.toLowerCase().indexOf("/rest/"),r=i.substring(0,l)+i.substring(l+5,i.length);i=oi+"?soapUrl="+encodeURI(r)+"&returnbytes=true"}return st(i,{query:s}).then(l=>l.data)}async _constructLegendElementsForBuildingSceneLayer(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add(k(e,"sublayers",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){U.warn("Request to server for legend has failed!",t)}}async _generateLegendElementsForBuildingSublayers(e,t){let s=[];this._handles.add(e.on("change",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");const i=e.toArray();for(const l of i){const r=l.watch(["renderer","opacity","title","visible"],()=>this._constructLegendElementsForBuildingSceneLayer());if(this._handles.add(r,"sublayers-watcher"),!this.respectLayerVisibility||l.visible){const n=l&&l.opacity!=null?l.opacity:null,a=n!=null?n*t:t;if(l.type==="building-group"){const o={type:"symbol-table",title:l.title,infos:[]},u=await this._generateLegendElementsForBuildingSublayers(l.sublayers,a);o.infos.push(...u),s=[o,...s]}else l.renderer&&(s=[...await this._getRendererLegendElements(l.renderer,{title:l.title,opacity:a,sublayer:l}),...s])}}return s.filter(l=>!!l&&(!("infos"in l)||l.infos.length>0))}async _constructLegendElementsForSublayers(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add(k(e,"sublayers",()=>this._constructLegendElementsForSublayers),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){U.warn("Request to server for legend has failed!",t)}}async _generateLegendElementsForSublayers(e,t,s){const i=this.layer;let l=[];this._handles.add(e.on("change",()=>this._constructLegendElementsForSublayers()),"sublayers-watcher");let r=e.toArray();!s&&this.sublayerIds&&this.sublayerIds.length&&(r=this.sublayerIds.map(n=>i.findSublayerById(n)).filter(Boolean));for(const n of r){const a=n.watch("renderer, opacity, title, visible, legendEnabled",()=>this._constructLegendElementsForSublayers());if(this._handles.add(a,"sublayers-watcher"),!this.respectLayerVisibility||n.visible&&n.legendEnabled&&this._isSublayerInScale(n)){const o=n&&n.opacity!=null?n.opacity:null,u=o!=null?o*t:t;if(n.renderer&&!n.sublayers&&n.originIdOf("renderer")>2)await n.load(),l=[...await this._getRendererLegendElements(n.renderer,{title:n.title,opacity:u,sublayer:n}),...l];else{const c=await this._generateSymbolTableElementForSublayer(n,u,s);c&&l.unshift(c)}}}return l.filter(n=>!!n&&(!("infos"in n)||n.infos.length>0))}async _generateSymbolTableElementForSublayer(e,t,s){if(!s){s=new Map;const l=this.layer,r=e.source;let n=null;if(!(!r||r.type==="map-layer"&&r.mapLayerId===e.id&&(!r.gdbVersion||r.gdbVersion===("gdbVersion"in l&&l.gdbVersion)))||e.originIdOf("renderer")>2||e.originIdOf("labelingInfo")>2||e.originIdOf("labelsVisible")>2){const o=new ps({layer:this.layer});n=o.hasDynamicLayers?o.dynamicLayers:null,o.destroy()}const a=n||`${l.uid}-default`;(await this._getLegendLayers(a,n)).forEach(o=>s.set(o.layerId,o))}const i=s.get(e.id);if(!i&&e.sublayers){const l=await this._generateLegendElementsForSublayers(e.sublayers,t,s);return{type:"symbol-table",title:e.title,infos:l}}return this._generateSymbolTableElementForLegendLayer(i,e,t)}_generateSymbolTableElementForLegendLayer(e,t,s){var i;if(!e||!e.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;const l=t==null?void 0:t.renderer;let r=(t==null?void 0:t.title)||e.layerName;if(l&&(!t||(t==null?void 0:t.originIdOf("renderer"))>2)){const o=(t==null?void 0:t.title)||this._getRendererTitle(l,t);o&&(r&&typeof o!="string"&&"title"in o&&(o.title=r),r=o)}const n={type:"symbol-table",title:r,legendType:e.legendType?e.legendType:null,infos:[]},a=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return((i=e.legendGroups)==null?void 0:i.length)>0?e.legendGroups.forEach(o=>{var u;const c={type:"symbol-table",title:o.heading,legendType:e.legendType?e.legendType:null,infos:this._generateSymbolTableElementInfosForLegendLayer(a.filter(h=>h.groupId===o.id),e.layerId,s)};((u=c.infos)==null?void 0:u.length)>0&&n.infos.push(c)}):n.infos=this._generateSymbolTableElementInfosForLegendLayer(a,e.layerId,s),n.infos.length>0?n:null}_generateSymbolTableElementInfosForLegendLayer(e,t,s){return e.map(i=>{let l=i.url;if(i.imageData&&i.imageData.length>0)l=`data:image/png;base64,${i.imageData}`;else{if(l.indexOf("http")===0)return null;l=ts(`${this.layer.url}/${t}/images/${l}`)}return{label:i.label,src:l,opacity:s==null?this.opacity:s,width:i.width,height:i.height}}).filter(i=>!!i)}_isSublayerInScale(e){const t=e.minScale||0,s=e.maxScale||0;return!(t>0&&t<this.scale||s>this.scale)}_isLegendLayerInScale(e,t){const s=t||this.layer;let i=null,l=null,r=!0;return!s.minScale&&s.minScale!==0||!s.maxScale&&s.maxScale!==0?(e.minScale===0&&s.tileInfo&&(i=s.tileInfo.lods[0].scale),e.maxScale===0&&s.tileInfo&&(l=s.tileInfo.lods[s.tileInfo.lods.length-1].scale)):(i=Math.min(s.minScale,e.minScale)||s.minScale||e.minScale,l=Math.max(s.maxScale,e.maxScale)),(i>0&&i<this.scale||l>this.scale)&&(r=!1),r}_sanitizeLegendForSublayer(e,t){if("version"in this.layer&&this.layer.version<10.1||e.length===0)return e;const s=t.renderer,i=e.some(n=>n.values);let l=null,r=null;return i&&e.some((n,a)=>(n.values||(l=a,r=n,r.label||(r.label="others")),r!=null)),s?s.type==="unique-value"?r&&(e.splice(l,1),e.push(r)):s.type==="class-breaks"&&(r&&e.splice(l,1),e.reverse(),r&&e.push(r)):r&&(e.splice(l,1),e.push(r)),e}async _getRendererLegendElements(e,t={}){return fi(e,this.view)?pi(e)?this._constructPointCloudRendererLegendElements(e,t):St(e)?this._constructDotDensityRendererLegendElements(e):this._constructRendererLegendElements(e,t):(U.warn(`Renderer of type '${e.type}' not supported!`),[])}_getPointCloudRendererTitle(e){return e.legendOptions&&e.legendOptions.title||e.field}_constructPointCloudRendererLegendElements(e,t={}){const s=t.title,i=[];let l=null,r=null;if(Fe(e))l={type:"symbol-table",title:s||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach(a=>{l.infos.unshift({label:a.label||a.minValue+" - "+a.maxValue,value:[a.minValue,a.maxValue],symbol:this._getAppliedCloneSymbol(ve,a.color)})});else if(Me(e)){const a=e.stops;let o=null;if(a.length&&(a.length===1&&(o=a[0].color),!o)){const c=a[0].value,h=a[a.length-1].value;c!=null&&h!=null&&(o=ct(c+(h-c)/2,a))}l={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(ve,o||ve.color)}]};const u=Bs(e.stops);r={type:"color-ramp",title:s||this._getPointCloudRendererTitle(e),infos:u,preview:W(u.map(c=>c.color))}}else Be(e)&&(l={type:"symbol-table",title:s||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos.forEach(a=>{l.infos.push({label:a.label||a.values.join(", "),value:a.values.join(", "),symbol:this._getAppliedCloneSymbol(ve,a.color)})}));l&&l.infos.length&&i.push(l),r&&r.infos.length&&i.push(r);const n=i.reduce((a,o)=>a.concat(o.infos),[]).filter(a=>!!a.symbol).map(a=>this._getSymbolPreview(a,this.opacity,{symbolConfig:{applyColorModulation:!!e.colorModulation}}));return K(n).then(()=>i)}_getElementInfoForDotDensity(e,t){const{backgroundColor:s,outline:i,dotSize:l}=e,r=this.effectList,n=r==null?void 0:r.effects.map(g=>g.toJSON()),a=ss(n),o=l+"-"+t+"-"+s+"-"+(i&&JSON.stringify(i.toJSON()))+"-"+a,u=this._dotDensityUrlCache,c=u.has(o)?u.get(o):is(e,t);u.set(o,c);const h={shape:{type:"image",x:0,y:0,width:c.width,height:c.height,src:c.src},fill:null,stroke:null,offset:[0,0]},p=fs([[h]],[c.width,c.height],{effectView:this.effectList});return{opacity:1,src:c.src,preview:p,width:c.width,height:c.height}}_constructDotDensityRendererLegendElements(e){const t=e.calculateDotValue(this.view.scale),s=e.legendOptions&&e.legendOptions.unit,i={type:"symbol-table",title:{value:t&&Math.round(t),unit:s||""},infos:[]};return e.attributes.forEach(l=>{const r=this._getElementInfoForDotDensity(e,l.color);r.label=l.label||l.valueExpressionTitle||l.field,i.infos.push(r)}),Promise.resolve([i])}async _constructRendererLegendElements(e,t={}){const{title:s,sublayer:i}=t,l=i||this.layer;let r=await this._loadRenderer(e);this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null;const n=await this._getVisualVariableLegendElements(r,l)||[],a={type:"symbol-table",title:s||this._getRendererTitle(r,l),infos:[]};let o=null,u=!1;const c=new Set;if(Ii(r)){let y=s;const S=Ci(r)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",b=n.findIndex(T=>T.type==="color-ramp"),C=b!==-1?n.splice(b,1)[0]:null,w=n.findIndex(T=>T.type==="size-ramp"),A=w!==-1?n.splice(w,1)[0]:null,R=[];C&&(y=C.title,R.push(C)),A&&(y=A.title,R.push(A)),R.length>0&&n.push({type:S,title:y,infos:R})}else if(wt(r)){const y=Ds(r);n.push({type:"heatmap-ramp",title:s,infos:y,preview:W(y.map(S=>S.color),{effectList:this.effectList})})}else if(ke(r)){const y=r&&r.authoringInfo;if(y&&y.type==="relationship"){const{focus:S,numClasses:b,field1:C,field2:w}=y;if(b&&C&&w){const A=[C,w];let R=ut(S)||0;for(const j of A){const{field:N,normalizationField:E,label:q}=j,D=q||{field:this._getFieldAlias(N,l),normField:E&&this._getFieldAlias(E,l)},ne=Ai.clone();ne.angle=R,a.infos.push({label:D,symbol:ne}),c.add(ne),R+=90}const T=Us({focus:S,numClasses:b,infos:r.uniqueValueInfos});n.unshift(T)}}else{const S=r.field;r.uniqueValueInfos.forEach(b=>{b.symbol&&a.infos.push({label:b.label||this._getDomainName(S,b.value,l)||b.value,value:b.value,symbol:b.symbol})})}r.defaultSymbol&&(a.infos.push({label:r.defaultLabel||"others",symbol:r.defaultSymbol}),u=!0)}else if(Y(r))o=this._isUnclassedRenderer(r),(!o||!this._hasSizeRamp)&&(r.classBreakInfos.forEach(y=>{y.symbol&&a.infos.unshift({label:y.label||(o?null:y.minValue+" - "+y.maxValue),value:[y.minValue,y.maxValue],symbol:y.symbol})}),o&&(a.title=null),this._updateInfosforClassedSizeRenderer(r,a.infos)),r.defaultSymbol&&!o&&(a.infos.push({label:r.defaultLabel||"others",symbol:r.defaultSymbol}),u=!0);else if(_t(r))if(Ne(this.layer)||wi(this.layer)){const y=this._constructTileImageryStretchRendererElements(r);Si(y)?n.push(y):a.infos=y}else{const y=this.layer;let S,b;r.statistics&&r.statistics.length&&(S=r.statistics[0].min!=null?r.statistics[0].min:r.statistics[0][0],b=r.statistics[0].max!=null?r.statistics[0].max:r.statistics[0][1]);let C=[];const w=Ae(y.renderingRule?await y.generateRasterInfo(y.renderingRule):y.serviceRasterInfo),A=w.keyProperties.BandProperties,R=gt[y.rasterInfo.pixelType.toLowerCase()];w.bandCount===1||y.bandIds&&y.bandIds.length===1?(S=S!=null?S:w.statistics?w.statistics[y.bandIds[0]].min:R[0],b=b!=null?b:w.statistics?w.statistics[y.bandIds[0]].max:R[1],S||b?n.push(this._getStretchLegendElements(r,{min:S,max:b})):this._getServerSideLegend()):w.bandCount>=3?A&&A.length>=w.bandCount?y.bandIds&&y.bandIds.length===3?(C=y.bandIds.map(T=>A[T].BandName),a.infos=this._createSymbolTableElementMultiBand(C)):y.format==="lerc"?(C=[0,1,2].map(T=>A[T].BandName),a.infos=this._createSymbolTableElementMultiBand(C)):this._getServerSideLegend():y.format==="lerc"?(C=["band1","band2","band3"],a.infos=this._createSymbolTableElementMultiBand(C)):this._getServerSideLegend():this._getServerSideLegend()}else if(vt(r))r.colormapInfos.forEach(y=>{a.infos.push({label:y.label,value:y.value,symbol:this._getAppliedCloneSymbol(hi,y.color)})});else if(J(r)){let y=r.symbol;switch(t.geometryType){case"point":y="pointSymbol"in l&&l.pointSymbol;break;case"polyline":y="lineSymbol"in l&&l.lineSymbol;break;case"polygon":y="polygonSymbol"in l&&l.polygonSymbol}r.symbol&&!this._hasSizeRamp&&a.infos.push({label:r.label,symbol:y})}else if(bt(r)){r.outputUnit&&(this.title="("+r.toJSON().outputUnit+")"),a.title=r.attributeField;const y=r.getClassBreakInfos();y!=null&&y.length?y.forEach(S=>{a.infos.push({label:S.minValue+" - "+S.maxValue,symbol:S.symbol})}):a.infos.push({label:r.attributeField,symbol:r.getDefaultSymbol()})}else Lt(r)&&n.push(this._getStretchLegendElements(r,{min:0,max:255}));const h=r.defaultSymbol;!h||u||J(r)||o&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||n.push({type:"symbol-table",infos:[{label:r.defaultLabel||"others",symbol:h}]}),a.infos.length&&n.unshift(a);const p=t.opacity==null?this.opacity:t.opacity,g=this._isTallSymbol("visualVariables"in r&&r.visualVariables),m=ce(this.layer)||Ne(this.layer),_=n.reduce((y,S)=>y.concat(this._getAllInfos(S)),[]).filter(y=>!(y==null||!y.symbol)).map(y=>this._getSymbolPreview(y,p,{isDefault:y.symbol===h,applyScaleDrivenSize:!c.has(y.symbol),symbolConfig:{isTall:g,isSquareFill:m},effectList:c.has(y.symbol)?null:this.effectList}));return r=null,await K(_),n}_getServerSideLegend(){setTimeout(()=>this.buildLegendElementsForTools(),0)}_getAllInfos(e){const t=e==null?void 0:e.infos;return t?t.reduce((s,i)=>s.concat(this._getAllInfos(i)),[]):[e]}_constructTileImageryStretchRendererElements(e){var t,s;const i=this.layer,l=i.rasterInfo,r=l.bandCount||e.statistics.length;let n,a,o=[];const u=l.keyProperties&&l.keyProperties.BandProperties,c=e!=null&&(t=e.statistics)!=null&&t.length?e.statistics:l==null?void 0:l.statistics;if(c)n=c[0].min!==void 0?c[0].min:c[0][0],a=c[0].max||c[0][1];else{const p=gt[i.rasterInfo.pixelType.toLowerCase()];n=p[0],a=p[1]}if(i.hasStandardTime()&&(n=i.getStandardTimeValue(n),a=i.getStandardTimeValue(a)),l.bandCount===1||((s=i.bandIds)==null?void 0:s.length)===1)return this._getStretchLegendElements(e,{min:n,max:a});function h(p){var g;const m=(i!=null&&(g=i.bandIds)!=null&&g.length?i.bandIds:Array.from(Array(Math.min(l.bandCount,3)).keys())).map(_=>p&&p[_]&&p[_].BandName||"band"+(_+1));return m.length<3?m.push(m[1]):m.length>3&&m.splice(3),m}return o=u&&u.length>=r?h(u):h(),this._createSymbolTableElementMultiBand(o)}_getStretchLegendElements(e,t){const s=e.colorRamp,i=Os(s,t);return{type:"stretch-ramp",title:"",infos:i,preview:W(i.map(l=>l.color))}}_createSymbolTableElementMultiBand(e){const t=[],s=["red","green","blue"];return e.forEach((i,l)=>{t.push({label:{colorName:s[l],bandName:i},src:ks[l],opacity:1})}),t}_updateInfosforClassedSizeRenderer(e,t){const s=e.authoringInfo&&e.authoringInfo.type==="class-breaks-size",i=e.classBreakInfos.some(l=>Ie(l.symbol));if(s&&i){const l=ze,r=Te,n=e.classBreakInfos.length,a=(l-r)/(n>1?n-1:n);t.forEach((o,u)=>{o.size=l-a*u})}}_isTallSymbol(e){let t=!1,s=!1;if(e)for(let i=0;i<e.length&&(!t||!s);i++){const l=e[i];l.type==="size"&&(l.axis==="height"&&(t=!0),l.axis==="width-and-depth"&&(s=!0))}return t&&s}async _getSymbolPreview(e,t,s){let i=s!=null&&s.isDefault||e.size!=null||!this._hasSizeRamp?e.size:ls(22);if(this._scaleDrivenSizeVariable&&s!=null&&s.applyScaleDrivenSize){const{getSize:l}=await import("./index.fe92decb.js").then(function(r){return r.tt});i=l(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:e.symbol.type==="simple-marker"?e.symbol.style:null})}return rs(e.symbol,{size:i,opacity:t,scale:!1,symbolConfig:s==null?void 0:s.symbolConfig,effectView:s==null?void 0:s.effectList}).then(l=>(e.preview=l,e)).catch(()=>(e.preview=null,e))}async _loadRenderer(e){var t,s;const i=[],l=this.layer;e=e.clone(),this._hasClusterSizeVariable=!1;const r="visualVariables"in e&&((t=e.visualVariables)==null?void 0:t.some(a=>a.type==="size"&&a.target!=="outline"&&!be.test(a.valueExpression)));if(e&&"visualVariables"in e&&!r&&"featureReduction"in l&&((s=l.featureReduction)==null?void 0:s.type)==="cluster"){const a=this.layerView._effectiveRenderer,o=Ae(As(a,this.view));if(o){const u=l.featureReduction;if("clusterMinSize"in u&&"clusterMaxSize"in u){const{clusterMinSize:h,clusterMaxSize:p}=u;o.legendOptions=new ns({showLegend:h!==p})}const c=e.visualVariables||[];e.visualVariables=c.concat([o]),this._hasClusterSizeVariable=!0}}const n=await this._getMedianColor(e);if(Y(e)||ke(e)){const a=(e.classBreakInfos||e.uniqueValueInfos).map(o=>this._fetchSymbol(o.symbol,n).then(u=>{o.symbol=u}).catch(()=>{o.symbol=null}));Array.prototype.push.apply(i,a)}return i.push(this._fetchSymbol(e.symbol||e.defaultSymbol,e.defaultSymbol?null:n).then(a=>{this._applySymbolToRenderer(e,a,J(e))}).catch(()=>{this._applySymbolToRenderer(e,null,J(e))})),K(i).then(()=>e)}_applySymbolToRenderer(e,t,s){s?e.symbol=t:e.defaultSymbol=t}async _getMedianColor(e){if(!("visualVariables"in e)||!e.visualVariables)return null;const t=e.visualVariables.find(n=>n.type==="color");if(!t)return null;let s=null,i=null;if(t.stops){if(t.stops.length===1)return t.stops[0].color;s=t.stops[0].value,i=t.stops[t.stops.length-1].value}const l=s+(i-s)/2,{getColor:r}=await import("./index.fe92decb.js").then(function(n){return n.tt});return r(t,l)}_fetchSymbol(e,t){if(!e)return Promise.reject();if(e.type==="web-style"){const s=e.portal,i=s&&s.url,l=s&&s.user&&s.user.username,r=e.name+"-"+e.styleName+"-"+e.styleUrl+"-"+i+"-"+l,n=this._webStyleSymbolCache;return n.has(r)||(this.view.type==="2d"?n.set(r,e.fetchCIMSymbol()):n.set(r,e.fetchSymbol())),n.get(r).then(a=>this._getAppliedCloneSymbol(a,t)).catch(()=>(U.warn("Fetching web-style failed!"),Promise.reject()))}return Promise.resolve(this._getAppliedCloneSymbol(e,t))}_getAppliedCloneSymbol(e,t){if(!e||!t)return e;const s=e.clone(),i=t&&t.toRgba();return s.type.indexOf("3d")>-1?this._applyColorTo3dSymbol(s,i):s.type==="cim"?Je(s,t):s.color&&(s.color=new F(i||s.color)),s}_applyColorTo3dSymbol(e,t){t&&e.symbolLayers.forEach(s=>{s&&(s.material||(s.material={}),s.material.color=new F(t))})}async _getVisualVariableLegendElements(e,t){if(!("visualVariables"in e)||!e.visualVariables||e.type==="vector-field")return null;const s=e.visualVariables,i=[],l=[],r=[];for(const c of s)c.type==="color"?i.push(c):c.type==="size"?l.push(c):c.type==="opacity"&&r.push(c);const n=[...i,...l,...r];let a,o;if(i.length===0&&Y(e)&&e.classBreakInfos&&e.classBreakInfos.length===1){const c=e.classBreakInfos[0];a=c&&c.symbol}if(i.length===0&&J(e)&&(a=e.symbol),a)if(a.type.indexOf("3d")>-1){const c=a.symbolLayers.getItemAt(0);c.type==="water"?$e(c.color)&&(o=c.color):$e(c.material)&&$e(c.material.color)&&(o=c.material.color)}else a.url||(o=a.color);const u=this.effectList;return(await Promise.all(n.map(async c=>{if(!c.legendOptions||c.legendOptions.showLegend!==!1){const h=this._getRampTitle(c,t);let p=null;const g="getField"in t&&t.getField&&t.getField(c.field),m=g&&as(g);if(c.type==="color"){const _=await ot(c,null,m);p={type:"color-ramp",title:h,infos:_,preview:W(_.map(y=>y.color),{effectList:u})},this._hasColorRamp||(this._hasColorRamp=!(p.infos==null||!p.infos.length))}else if(c.type==="size"&&c.target!=="outline")be.test(c.valueExpression)?this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=c):(p={type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(c):h,infos:await Ys(e,c,await this._getMedianColor(e),this.scale,this.view.type,m)},this._hasSizeRamp||(this._hasSizeRamp=!(p.infos==null||!p.infos.length)));else if(c.type==="opacity"){const _=await ot(c,o,m);p={type:"opacity-ramp",title:h,infos:_,preview:W(_.map(y=>y.color),{effectList:u})},this._hasOpacityRamp||(this._hasOpacityRamp=!(p.infos==null||!p.infos.length))}return p&&p.infos?p:null}}))).filter(c=>!!c)}_getDomainName(e,t,s){if(e&&typeof e!="function"){const i="getField"in s&&s.getField&&s.getField(e),l=i&&"getFieldDomain"in s&&s.getFieldDomain?s.getFieldDomain(i.name):null;return l&&l.type==="coded-value"?l.getName(t):null}return null}_getClusterTitle(e){const t=this.layer,s=e.field;if("featureReduction"in t&&t.featureReduction&&t.featureReduction.type==="cluster"){const i=t.featureReduction,l="popupTemplate"in i&&i.popupTemplate,r=l&&l.fieldInfos;if(r){for(const n of r)if(n.fieldName===s)return s==="cluster_count"?n.label||{showCount:!0}:n.label}}return{showCount:!0}}_getRampTitle(e,t){let s=e.field,i=e.normalizationField,l=!1,r=!1,n=!1,a=null;s=typeof s=="function"?null:s,i=typeof i=="function"?null:i;const o=e.legendOptions&&e.legendOptions.title;if(o!=null)a=o;else if(e.valueExpressionTitle)a=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo&&t.renderer.authoringInfo.visualVariables){const u=t.renderer.authoringInfo.visualVariables;for(let c=0;c<u.length;c++){const h=u[c];if(h.type==="color"){if(h.style==="ratio"){l=!0;break}if(h.style==="percent"){r=!0;break}if(h.style==="percent-of-total"){n=!0;break}}}}a={field:s&&this._getFieldAlias(s,t),normField:i&&this._getFieldAlias(i,t),ratio:l,ratioPercent:r,ratioPercentTotal:n}}return a}_getRendererTitle(e,t){const s=e;if(s.legendOptions&&s.legendOptions.title)return s.legendOptions.title;if(s.valueExpressionTitle)return s.valueExpressionTitle;let i=s.field,l=null,r=null;Y(s)&&(l=s.normalizationField,r=s.normalizationType==="percent-of-total"),i=typeof i=="function"?null:i,l=typeof l=="function"?null:l;let n=null;return(i||l)&&(n={field:i&&this._getFieldAlias(i,t),normField:l&&this._getFieldAlias(l,t),normByPct:r}),n}_getFieldAlias(e,t){const s="popupTemplate"in t&&t.popupTemplate,i=s&&s.fieldInfos;let l=null;i&&i.some(o=>e===o.fieldName&&(l=o,!0));let r=null;"getField"in t&&t.getField?r=t.getField(e):"fieldsIndex"in t&&t.fieldsIndex&&(r=t.fieldsIndex.get(e));const n=l||r;let a=null;return n&&(a=l&&l.label||r&&r.alias||"name"in n&&n.name||"fieldName"in n&&n.fieldName),a}_isUnclassedRenderer(e){const t=e.visualVariables;let s=!1;return Y(e)&&e.classBreakInfos&&e.classBreakInfos.length===1&&t&&(s=e.field?t.some(i=>!(!i||e.field!==i.field||(e.normalizationField||i.normalizationField)&&e.normalizationField!==i.normalizationField)):!!t.length),s}};v([I()],x.prototype,"children",void 0),v([I({readOnly:!0})],x.prototype,"effectList",null),v([I()],x.prototype,"layerView",void 0),v([I()],x.prototype,"layer",void 0),v([I()],x.prototype,"legendElements",void 0),v([I({readOnly:!0})],x.prototype,"opacity",null),v([I()],x.prototype,"parent",void 0),v([I({readOnly:!0,dependsOn:[]})],x.prototype,"ready",null),v([I()],x.prototype,"hideLayersNotInCurrentView",void 0),v([I()],x.prototype,"keepCacheOnDestroy",void 0),v([I()],x.prototype,"respectLayerVisibility",void 0),v([I({readOnly:!0})],x.prototype,"scale",null),v([I()],x.prototype,"sublayerIds",void 0),v([I({readOnly:!0})],x.prototype,"isScaleDriven",null),v([I()],x.prototype,"title",void 0),v([I({readOnly:!0,dependsOn:["ready"],value:0})],x.prototype,"version",null),v([I()],x.prototype,"view",void 0),x=v([ae("esri.widgets.Legend.support.ActiveLayerInfo")],x);const At=x,G={state:"state",view:"view",allLayerViews:"all-layer-views",legendProperties:"legend-properties"},$t=Ce.ofType(At),$i=["esri.layers.BuildingSceneLayer","esri.layers.CSVLayer","esri.layers.FeatureLayer","esri.layers.GeoJSONLayer","esri.layers.GeoRSSLayer","esri.layers.GroupLayer","esri.layers.HeatmapLayer","esri.layers.ImageryLayer","esri.layers.ImageryTileLayer","esri.layers.MapImageLayer","esri.layers.OGCFeatureLayer","esri.layers.PointCloudLayer","esri.layers.StreamLayer","esri.layers.SceneLayer","esri.layers.TileLayer","esri.layers.VoxelLayer","esri.layers.WFSLayer","esri.layers.WMSLayer","esri.layers.WMTSLayer","esri.layers.WCSLayer"],Et="view.basemapView.baseLayerViews",Rt="view.groundView.layerViews",xt="view.basemapView.referenceLayerViews",Ei=[Et,Rt,"view.layerViews",xt];let M=class extends tt{constructor(e){super(e),this._handles=new de,this._layerViewByLayerId={},this._layerInfosByLayerViewId={},this._activeLayerInfosByLayerViewId={},this._activeLayerInfosWithNoParent=new Ce,this.activeLayerInfos=new $t,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.layerInfos=[],this.view=null}initialize(){this._handles.add(oe(this,"view",this._viewHandles),G.view),this._handles.add(os(()=>this._refresh()))}destroy(){this._destroyViewActiveLayerInfos(),this._handles.destroy(),this._handles=null,this.view=null}get state(){return this.get("view.ready")?"ready":"disabled"}_viewHandles(){this._handles.remove(G.state),this.view&&this._handles.add(oe(this,"state",this._stateHandles),G.state)}_stateHandles(){this._resetAll(),this.state==="ready"&&this._watchPropertiesAndAllLayerViews()}_resetAll(){this._handles.remove([G.allLayerViews,G.legendProperties]),this._destroyViewActiveLayerInfos(),this.activeLayerInfos.removeAll()}_destroyViewActiveLayerInfos(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,this)}_destroyViewActiveLayerInfo(e){this._handles.remove(e);const t=this._activeLayerInfosByLayerViewId[e];delete this._activeLayerInfosByLayerViewId[e],t&&t.parent&&t.parent.children.remove(t)}_watchPropertiesAndAllLayerViews(){const{allLayerViews:e}=this.view;e.length&&this._refresh(),this._handles.add(e.on("change",this._allLayerViewsChangeHandle.bind(this)),G.allLayerViews),this._handles.add(k(this,"layerInfos, basemapLegendVisible, groundLegendVisible",this._propertiesChangeHandle.bind(this)),G.legendProperties)}_allLayerViewsChangeHandle(e){e.removed.forEach(t=>this._destroyViewActiveLayerInfo(t.uid)),this._refresh()}_propertiesChangeHandle(){this._destroyViewActiveLayerInfos(),this._refresh()}_refresh(){this._layerInfosByLayerViewId={},this.activeLayerInfos.removeAll(),this._generateLayerViews().filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,this),this._sortActiveLayerInfos(this.activeLayerInfos)}_sortActiveLayerInfos(e){if(e.length<2)return;const t=[];e.forEach(i=>{if(!i.parent){const l=i.layer.parent,r=l&&"uid"in l&&this._layerViewByLayerId[l.uid],n=r&&this._activeLayerInfosByLayerViewId[r.uid];n&&e.indexOf(n)!==-1&&(t.push(i),i.parent=n,n.children.add(i),this._sortActiveLayerInfos(n.children))}}),e.removeMany(t);const s={};this.view.allLayerViews.forEach((i,l)=>s[i.layer.uid]=l),e.sort((i,l)=>{const r=s[i.layer.uid]||0;return(s[l.layer.uid]||0)-r})}_generateLayerViews(){const e=[];return Ei.filter(this._filterLayerViews,this).map(this.get,this).filter(t=>t!=null).forEach(this._collectLayerViews("layerViews",e)),e}_filterLayerViews(e){const t=!this.basemapLegendVisible&&(e===Et||e===xt),s=!this.groundLegendVisible&&e===Rt;return!t&&!s}_collectLayerViews(e,t){const s=i=>(i&&i.forEach(l=>{t.push(l),s(l[e])}),t);return s}_filterLayerViewsByLayerInfos(e){const t=this.layerInfos;return!t||!t.length||t.some(s=>this._hasLayerInfo(s,e))}_hasLayerInfo(e,t){const s=this._isLayerUIDMatching(e.layer,t.layer.uid);return s&&(this._layerInfosByLayerViewId[t.uid]=e),s}_isLayerUIDMatching(e,t){return e&&(e.uid===t||this._hasLayerUID(e.layers,t))}_hasLayerUID(e,t){return e&&e.some(s=>this._isLayerUIDMatching(s,t))}_isLayerViewSupported(e){return!!$i.includes(e.layer.declaredClass)&&(this._layerViewByLayerId[e.layer.uid]=e,!0)}_generateActiveLayerInfo(e){this._isLayerActive(e)?this._buildActiveLayerInfo(e):(this._handles.remove(e.uid),this._handles.add(k(e,"legendEnabled, layer.legendEnabled",()=>this._layerActiveHandle(e)),e.uid))}_layerActiveHandle(e){this._isLayerActive(e)&&(this._handles.remove(e.uid),this._buildActiveLayerInfo(e))}_isLayerActive(e){return!this.respectLayerVisibility||e.legendEnabled&&e.get("layer.legendEnabled")}_buildActiveLayerInfo(e){var t;const s=e.layer,i=e.uid,l=this._layerInfosByLayerViewId[i];let r=this._activeLayerInfosByLayerViewId[i];if(!r){const a=l&&l.title!==void 0&&l.layer.uid===s.uid;r=new At({layer:s,layerView:e,title:a?l.title:s.title,view:this.view,respectLayerVisibility:this.respectLayerVisibility,hideLayersNotInCurrentView:this.hideLayersNotInCurrentView,keepCacheOnDestroy:this.keepCacheOnDestroy,sublayerIds:l&&l.sublayerIds||[]}),this._activeLayerInfosByLayerViewId[i]=r}const n=s.parent&&"uid"in s.parent&&this._layerViewByLayerId[(t=s.parent)==null?void 0:t.uid];if(r.parent=this._activeLayerInfosByLayerViewId[n==null?void 0:n.uid],!this._handles.has(i)){const a=[k(s,"title",o=>this._titleHandle(o,r)),k(s,"renderer?, opacity, pointSymbol?, lineSymbol?, polygonSymbol?",()=>this._constructLegendElements(r)),cs(this.view,"stationary",()=>this._scaleHandle(r)),k(e,"_effectiveRenderer",()=>this._constructLegendElements(r)),k(s,"effect",()=>this._constructLegendElements(r))];if(this.respectLayerVisibility){const o=k(e,"legendEnabled",c=>this._legendEnabledHandle(c,r)),u=k(s,"legendEnabled",c=>this._legendEnabledHandle(c,r));a.push(o,u)}this._handles.add(a,i)}r.isScaleDriven||this._constructLegendElements(r),this._addActiveLayerInfo(r)}_titleHandle(e,t){t.title=e,this._constructLegendElements(t)}_legendEnabledHandle(e,t){e?this._addActiveLayerInfo(t):this._removeActiveLayerInfo(t)}_scaleHandle(e){(e.isScaleDriven||e.hideLayersNotInCurrentView)&&this._constructLegendElements(e)}_addActiveLayerInfo(e){const{layerView:t,layer:s}=e;if(this._isLayerActive(t)&&this.activeLayerInfos.indexOf(e)===-1){const l=e.parent;if(l)l.children.indexOf(e)===-1&&l.children.push(e),this._sortActiveLayerInfos(l.children);else{var i;const r=(i=this.layerInfos)==null?void 0:i.some(n=>n.layer.uid===s.uid);s.parent&&"uid"in s.parent&&!r?this._activeLayerInfosWithNoParent.add(e):(this.activeLayerInfos.add(e),this._sortActiveLayerInfos(this.activeLayerInfos))}if(this._activeLayerInfosWithNoParent.length){const r=[];this._activeLayerInfosWithNoParent.forEach(n=>{const a=n.layer.parent,o=a&&"uid"in a&&this._layerViewByLayerId[a==null?void 0:a.uid],u=this._activeLayerInfosByLayerViewId[o==null?void 0:o.uid];u&&(r.push(n),n.parent=u)}),r.length&&(this._activeLayerInfosWithNoParent.removeMany(r),r.forEach(n=>this._addActiveLayerInfo(n)))}}}_removeActiveLayerInfo(e){const t=e.parent;t?t.children.remove(e):this.activeLayerInfos.remove(e)}_constructLegendElements(e){const t=e.layer;"featureCollections"in t&&t.featureCollections?e.buildLegendElementsForFeatureCollections(t.featureCollections):"renderer"in t&&t.renderer?e.buildLegendElementsForRenderer(t.renderer):"url"in t&&t.url?e.buildLegendElementsForTools():e.children.forEach(s=>this._constructLegendElements(s))}};v([I({type:$t})],M.prototype,"activeLayerInfos",void 0),v([I()],M.prototype,"basemapLegendVisible",void 0),v([I()],M.prototype,"groundLegendVisible",void 0),v([I()],M.prototype,"hideLayersNotInCurrentView",void 0),v([I()],M.prototype,"keepCacheOnDestroy",void 0),v([I()],M.prototype,"respectLayerVisibility",void 0),v([I()],M.prototype,"layerInfos",void 0),v([I({readOnly:!0})],M.prototype,"state",null),v([I()],M.prototype,"view",void 0),M=v([ae("esri.widgets.Legend.LegendViewModel")],M);const Ri=M,xi="http://www.w3.org/2000/svg",$={diamondContainer:"esri-relationship-ramp--diamond__container",diamondLeftCol:"esri-relationship-ramp--diamond__left-column",diamondRightCol:"esri-relationship-ramp--diamond__right-column",diamondMidCol:"esri-relationship-ramp--diamond__middle-column",diamondMidColLabel:"esri-relationship-ramp--diamond__middle-column--label",diamondMidColRamp:"esri-relationship-ramp--diamond__middle-column--ramp",squareTable:"esri-relationship-ramp--square__table",squareTableRow:"esri-relationship-ramp--square__table-row",squareTableCell:"esri-relationship-ramp--square__table-cell",squareTableLabel:"esri-relationship-ramp--square__table-label",squareTableLabelLeftBottom:"esri-relationship-ramp--square__table-label--left-bottom",squareTableLabelRightBottom:"esri-relationship-ramp--square__table-label--right-bottom",squareTableLabelLeftTop:"esri-relationship-ramp--square__table-label--left-top",squareTableLabelRightTop:"esri-relationship-ramp--square__table-label--right-top"};function Vt(e,t,s,i){const{focus:l,labels:r}=e,n=!!l,a=Vi(e,t,s,i);return n?d("div",{class:$.diamondContainer},d("div",{class:$.diamondLeftCol},r.left),d("div",{class:$.diamondMidCol},d("div",{class:$.diamondMidColLabel},r.top),a,d("div",{class:$.diamondMidColLabel},r.bottom)),d("div",{class:$.diamondRightCol},r.right)):d("div",{class:$.squareTable},d("div",{class:$.squareTableRow},d("div",{class:ye($.squareTableCell,$.squareTableLabel,$.squareTableLabelRightBottom)},r.left),d("div",{class:$.squareTableCell}),d("div",{class:ye($.squareTableCell,$.squareTableLabel,$.squareTableLabelLeftBottom)},r.top)),d("div",{class:$.squareTableRow},d("div",{class:$.squareTableCell}),a,d("div",{class:$.squareTableCell})),d("div",{class:$.squareTableRow},d("div",{class:ye($.squareTableCell,$.squareTableLabel,$.squareTableLabelRightTop)},r.bottom),d("div",{class:$.squareTableCell}),d("div",{class:ye($.squareTableCell,$.squareTableLabel,$.squareTableLabelLeftTop)},r.right)))}function zt(e,t,s){const i=`${s}_arrowStart`,l=`${s}_arrowEnd`,r=e==="left",n={markerStart:null,markerEnd:null};switch(t){case"HL":r?n.markerStart=`url(#${l})`:n.markerEnd=`url(#${i})`;break;case"LL":n.markerStart=`url(#${l})`;break;case"LH":r?n.markerEnd=`url(#${i})`:n.markerStart=`url(#${l})`;break;default:n.markerEnd=`url(#${i})`}return n}function Vi(e,t,s,i,l=60){const{focus:r,numClasses:n,colors:a,rotation:o}=e,u=!!r,c=Math.sqrt(l**2+l**2)+(u?0:5),h=[],p=[],g=[],m=(l||75)/n;for(let E=0;E<n;E++){const q=E*m;for(let D=0;D<n;D++){const ne=D*m,je=gs(a[E][D]),Dt=bs(null),We={type:"rect",x:ne,y:q,width:m,height:m};h.push(vs(je)),p.push(_s(We,je.fill,Dt,null)),g.push(Ls(We))}}const _=10,y=15,S=15,b=10;let C=null;u||(C="margin: -15px -15px -18px -15px");const w=zt("left",r,t),A=zt("right",r,t),R=ws(g),T=it(R,c,c,0,!1,o,!1),j=it(R,c,c,0,!1,u?-45:null,!1),N={filter:Ee(i),opacity:s==null?null:`${s}`};return d("div",{styles:N,class:u?$.diamondMidColRamp:$.squareTableCell},d("svg",{xmlns:xi,width:c,height:c,style:C},d("defs",null,d("marker",{id:`${t}_arrowStart`,markerWidth:"10",markerHeight:"10",refX:"5",refY:"5",markerUnits:"strokeWidth",orient:"auto"},d("polyline",{points:"0,0 5,5 0,10",fill:"none",stroke:"#555555","stroke-width":"1"})),d("marker",{id:`${t}_arrowEnd`,markerWidth:"10",markerHeight:"10",refX:"0",refY:"5",markerUnits:"strokeWidth",orient:"auto"},d("polyline",{points:"5,0 0,5 5,10",fill:"none",stroke:"#555555","stroke-width":"1"})),h),d("g",{transform:T},p),d("g",{transform:j},d("line",{fill:"none",stroke:"#555555","stroke-width":"1","marker-start":w.markerStart,"marker-end":w.markerEnd,x1:-_,y1:l-y,x2:-_,y2:y}),d("line",{fill:"none",stroke:"#555555","stroke-width":"1","marker-start":A.markerStart,"marker-end":A.markerEnd,x1:S,y1:l+b,x2:l-S,y2:l+b}))))}const zi=ds(),Tt=10,Oe=20,_e=10,De=20,qe={univariateAboveAndBelowSymbol:"esri-univariate-above-and-below-ramp__symbol",colorRamp:"esri-legend__color-ramp"};function Ti(e="vertical"){const t="stroke:rgb(200, 200, 200);stroke-width:1";return e==="vertical"?d("svg",{height:"4",width:"10"},d("line",{x1:"0",y1:"2",x2:"10",y2:"2",style:t})):d("svg",{height:"10",width:"10"},d("line",{x1:"5",y1:"0",x2:"5",y2:"10",style:t}))}function ki(e,t="vertical"){const s=document.createElement("div");return s.style.height=`${Oe}px`,s.className=qe.univariateAboveAndBelowSymbol,e!=null&&(s.style.opacity=e.toString()),zi.append(s,Ti.bind(null,t)),s}function kt(e,t,s="vertical",i){e.infos.forEach((l,r)=>{if(i&&r===2)l.preview=ki(t,s);else{const n=P(l.size)+(s==="horizontal"?De:_e),a=l.preview.tagName.toLowerCase()==="div",o=a?l.preview:document.createElement("div");o.className=qe.univariateAboveAndBelowSymbol,s==="horizontal"?o.style.width=`${n}px`:o.style.height=`${n}px`,a||o.appendChild(l.preview),l.preview=o}})}function Le(e,t="classic"){const s=e.infos;return t==="classic"?(P(s[0].size)+_e)/2:(P(s[0].size)-P(s[s.length-1].size))/2}function ee(e,t){if(!e)return null;const s=e.infos.map(l=>l.color),i=W(t.type==="full"?s:t.type==="above"?s.slice(0,3):s.slice(2,5),{width:t.width,height:t.height,align:t.rampAlignment,effectList:t.effectList});return i.className=qe.colorRamp,t.opacity!=null&&(i.style.opacity=t.opacity.toString()),i}function Pe(e,t,s,i="vertical"){let l=0;const r=e.infos,n=Math.floor(r.length/2),a=t==="full"||t==="above"?0:n,o=t==="full"||t==="below"?r.length-1:n;for(let u=a;u<=o;u++)s&&u===n?l+=i==="horizontal"?Tt:Oe:l+=P(r[u].size)+(i==="horizontal"?De:_e);return Math.round(l)}function te(e,t,s,i="vertical"){const l=Pe(e,t,s,i),r=e.infos,n=Math.floor(r.length/2),a=t==="full"||t==="above"?0:n,o=t==="full"||t==="below"?r.length-1:n,u=t==="full"?r[a].size+r[o].size:t==="above"?r[a].size:r[o].size,c=s?i==="vertical"?Oe:Tt:0,h=i==="vertical"?_e*(t==="full"?2:1):De*(t==="full"?2:1);return Math.round(l-(P(u)/2+c/2+h/2))}function Ft(e,t,s="vertical"){const i=e.infos;let l=i.filter(({type:o})=>o==="size-ramp")[0],r=i.filter(({type:o})=>o==="color-ramp")[0];var n,a;return l&&(l=O({},l),l.infos=[...l.infos],kt(l,t,s,!0)),r&&(r=O({},r),r.infos=[...r.infos]),s==="horizontal"&&((n=l)==null||n.infos.reverse(),(a=r)==null||a.infos.reverse()),{sizeRampElement:l,colorRampElement:r}}function Mt(e,t="vertical"){const s=e.infos;let i=s.filter(({type:a})=>a==="size-ramp")[0],l=s.filter(({type:a})=>a==="color-ramp")[0];var r,n;return i&&(i=O({},i),i.infos=[...i.infos],kt(i,null,t,!1)),l&&(l=O({},l),l.infos=[...l.infos]),t==="horizontal"&&((r=i)==null||r.infos.reverse(),(n=l)==null||n.infos.reverse()),{sizeRampElement:i,colorRampElement:l}}function Fi(e,t){return t}function z(e){const t=this;e.appendChild(t)}function se(e,t,s){if(!t)return;if(typeof t=="string"||typeof t=="number")return t;if("value"in t||"unit"in t)return Re(e.dotValue,t);if("colorName"in t||"bandName"in t)return e[t.colorName]+": "+(e[t.bandName]||t.bandName);if("showCount"in t)return t.showCount?e.clusterCountTitle:null;let i=null;return Fi(t,s)?i=t.ratioPercentTotal?"showRatioPercentTotal":t.ratioPercent?"showRatioPercent":t.ratio?"showRatio":t.normField?"showNormField":t.field?"showField":null:Bt(t,s)&&(i=t.normField?"showNormField":t.normByPct?"showNormPct":t.field?"showField":null),i?Re(i==="showField"?"{field}":e[i],{field:t.field,normField:t.normField}):null}function Bt(e,t){return!t}function Nt(e,t){return!!(t&&t==="Stretched"&&e.version>=10.3&&e.declaredClass==="esri.layers.ImageryLayer")}const f={activated:"esri-legend--card__carousel-indicator--activated",base:"esri-legend--card",stacked:"esri-legend--stacked",carouselTitle:"esri-legend--card__carousel-title",indicator:"esri-legend--card__carousel-indicator",intervalSeparator:"esri-legend--card__interval-separator",imageryLayerStretchedImage:"esri-legend--card__imagery-layer-image--stretched",imageLabel:"esri-legend--card__image-label",layerCaption:"esri-legend--card__layer-caption",labelElement:"esri-legend--card__label-element",layerRow:"esri-legend--card__layer-row",labelCell:"esri-legend--card__label-cell",message:"esri-legend--card__message",rampLabel:"esri-legend--card__ramp-label",section:"esri-legend--card__section",relationshipSection:"esri-legend--card__relationship-section",serviceCaptionText:"esri-legend--card__service-caption-text",serviceContent:"esri-legend--card__service-content",service:"esri-legend--card__service",groupLayer:"esri-legend--card__group-layer",groupLayerChild:"esri-legend--card__group-layer-child",symbol:"esri-legend--card__symbol",sizeRampRow:"esri-legend--card__size-ramp-row",symbolRow:"esri-legend--card__symbol-row",symbolCell:"esri-legend--card__symbol-cell",indicatorContainer:"esri-legend--card__carousel-indicator-container",intervalSeparatorsContainer:"esri-legend--card__interval-separators-container",relationshipLabelContainer:"esri-legend--card__relationship-label-container",labelContainer:"esri-legend--card__label-container",serviceCaptionContainer:"esri-legend--card__service-caption-container",symbolContainer:"esri-legend--card__symbol-container",sizeRampContainer:"esri-legend--card__size-ramp-container",sizeRampPreview:"esri-legend--card__size-ramp-preview",rampContainer:"esri-legend__ramps",sizeRampHorizontal:"esri-legend__size-ramp--horizontal",rampLabelsContainer:"esri-legend__ramp-labels",layerInfo:"esri-legend__layer-cell esri-legend__layer-cell--info",univariateAboveAndBelowColorRamp:"esri-univariate-above-and-below-ramp__color--card",hidden:"esri-hidden"},Mi=25,Bi=25,Ni=768,Oi=100,Di="#ddd",ie=window.devicePixelRatio;function qi(e){if(e){if(e.type.indexOf("3d")>-1){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const s=e.symbolLayers.getItemAt(t-1),i=s.resource&&s.resource.primitive;return i==="circle"||i==="cross"||i==="kite"||i==="sphere"||i==="cube"||i==="diamond"}{const t=e.style;return t==="circle"||t==="diamond"||t==="cross"}}}function Pi(e){if(e){if(e.type.indexOf("3d")>-1){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const s=e.symbolLayers.getItemAt(t-1).get("resource.primitive");return s==="triangle"||s==="cone"||s==="tetrahedron"}return e.style==="triangle"}}let B=class extends xe{constructor(e,t){super(e,t),this._handles=new de,this._hasIndicators=!1,this._selectedSectionName=null,this._sectionNames=[],this._sectionMap=new Map,this.activeLayerInfos=null,this.headingLevel=3,this.layout="stack",this.messages=null,this.messagesCommon=null,this.type="card",this.view=null}initialize(){this.own([this.watch("activeLayerInfos",e=>{this._handles.removeAll(),this._watchForSectionChanges(e)})])}destroy(){this._handles.destroy(),this._handles=null}render(){this._hasIndicators=this.layout==="auto"&&this.view.container.clientWidth<=Ni||this.layout==="stack";const e=this.activeLayerInfos,t=e&&e.toArray().map(a=>this._renderLegendForLayer(a)).filter(a=>!!a);this._hasIndicators?this._selectedSectionName&&this._sectionNames.indexOf(this._selectedSectionName)!==-1||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;const s=this._sectionNames.length,i=this._sectionNames.map((a,o)=>{const u=Re(this.messagesCommon.pagination.pageText,{index:o+1,total:s});return d("div",{key:a,role:"tab",id:a,"aria-label":u,"aria-controls":`${a}-panel`,"aria-selected":(this._selectedSectionName===a).toString(),tabIndex:this._selectedSectionName===a?0:-1,title:u,onclick:this._selectSection,onkeydown:this._focusSection,bind:this,class:this.classes(f.indicator,{[f.activated]:this._selectedSectionName===a}),"data-section-name":a})}),l=this._hasIndicators&&s>1?d("div",{class:f.indicatorContainer,key:"carousel-navigation",role:"tablist"},i):null,r=this._hasIndicators?this._sectionMap.get(this._selectedSectionName):t&&t.length?t:null,n={[f.stacked]:this._hasIndicators};return d("div",{class:this.classes(f.base,n)},r||d("div",{class:f.message},this.messages.noLegend),l)}_selectSection(e){const t=e.target.getAttribute("data-section-name");t&&(this._selectedSectionName=t)}_focusSection(e){switch(e.key){case"ArrowLeft":case"ArrowRight":this._switchSectionOnArrowPress(e);break;case"Enter":case" ":this._selectSection(e)}}_switchSectionOnArrowPress(e){const t=e.key,s=t==="ArrowLeft"?-1:1,i=e.target.getAttribute("data-section-name"),l=this._sectionNames.indexOf(i),r=this._sectionNames;let n=null;l!==-1&&(r[l+s]?n=document.getElementById(r[l+s]):t==="ArrowLeft"?n=document.getElementById(r[r.length-1]):t==="ArrowRight"&&(n=document.getElementById(r[0])),n&&n.focus())}_watchForSectionChanges(e){if(this._generateSectionNames(),e){e.forEach(s=>{const i=`activeLayerInfo-${s.layer.uid}-version-change`;this._handles.remove(i),this._watchForSectionChanges(s.children),this._handles.add(s.watch("version",()=>this._generateSectionNames()),i)});const t="activeLayerInfos-collection-change";this._handles.remove(t),this._handles.add(e.on("change",()=>this._watchForSectionChanges(e)),t)}}_generateSectionNames(){this._sectionNames.length=0,this._selectedSectionName=null,this.activeLayerInfos&&this.activeLayerInfos.forEach(this._generateSectionNamesForActiveLayerInfo,this)}_getSectionName(e,t,s){return`${this.id}${e.uid}-type-${t.type}-${s}`}_generateSectionNamesForActiveLayerInfo(e){e.children.forEach(this._generateSectionNamesForActiveLayerInfo,this),e.legendElements&&e.legendElements.forEach((t,s)=>{this._sectionNames.push(this._getSectionName(e.layer,t,s))})}_renderLegendForLayer(e){if(!e.ready)return null;if(e.children.length){const t=e.children.map(s=>this._renderLegendForLayer(s)).toArray();return d("div",{key:e.layer.uid,class:this.classes(f.service,f.groupLayer)},d("div",{class:f.serviceCaptionContainer},e.title),t)}{const t=e.legendElements;if(t&&!t.length)return null;const s=t.some(r=>r.type==="relationship-ramp"),i=t.map((r,n)=>this._renderLegendForElement(r,e,n,s)).filter(r=>!!r);if(!i.length)return null;const l={[f.groupLayerChild]:!!e.parent};return d("div",{key:e.layer.uid,class:this.classes(f.service,l)},d("div",{class:f.serviceCaptionContainer},d("div",{class:f.serviceCaptionText},e.title)),d("div",{class:f.serviceContent},i))}}_renderLegendForElement(e,t,s,i=!1){const l=e.type==="color-ramp",r=e.type==="opacity-ramp",n=e.type==="size-ramp",a=t.layer;let o=null;if(typeof e.title=="string")o=e.title;else if(e.title){const m=e.title,_=se(this.messages,m,l||r);o=m.title?`${m.title} (${_})`:_}const u=this._getSectionName(a,e,s),c=this._hasIndicators?d("div",null,d(pe,{level:this.headingLevel,class:f.carouselTitle},t.title),d(pe,{level:this.headingLevel+1,class:f.layerCaption},o)):o?d(pe,{level:this.headingLevel,class:f.layerCaption},o):null,h=t.effectList;let p=null;if(e.type==="symbol-table"){const m=e.infos.map((_,y)=>this._renderLegendForElementInfo(_,t,e.legendType,y)).filter(_=>!!_);if(m.length){const _=m[0].properties.classes&&m[0].properties.classes[f.symbolRow],y={[f.labelContainer]:!_&&!i,[f.relationshipLabelContainer]:i};p=d("div",{class:this.classes(y)},m)}}else e.type==="color-ramp"||e.type==="opacity-ramp"||e.type==="heatmap-ramp"?p=this._renderLegendForRamp(e,a.opacity,h):n?p=this._renderSizeRamp(e,a.opacity):e.type==="relationship-ramp"?p=Vt(e,this.id,a.opacity,h):e.type==="univariate-above-and-below-ramp"?p=this._renderUnivariateAboveAndBelowRamp(e,a.opacity,h):e.type==="univariate-color-size-ramp"&&(p=this._renderUnivariateColorSizeRamp(e,a.opacity,h));if(!p)return null;const g=d("div",{key:u,class:f.section,id:`${u}-panel`,role:"tabpanel","aria-labelledby":u,tabIndex:0},[c,p]);return this._sectionMap.set(u,g),g}_renderUnivariateAboveAndBelowRamp(e,t,s){const{sizeRampElement:i,colorRampElement:l}=Ft(e,t,"horizontal");if(!i)return null;const r=Pe(i,"full",!0,"horizontal"),n=te(i,"above",!0,"horizontal"),a=te(i,"below",!0,"horizontal"),o=12,u=ee(l,{width:n,height:o,rampAlignment:"horizontal",opacity:t,type:"above",effectList:s}),c=ee(l,{width:a,height:o,rampAlignment:"horizontal",opacity:t,type:"below",effectList:s}),h=Le(i,"card"),p=i.infos.map(C=>C.label),g=p.length-1,m=p.map((C,w)=>w===0||w===g?d("div",{key:w},C):null),_={display:"flex",flexDirection:"column"},y={display:"flex",flexDirection:"row"},S={marginTop:"3px",marginLeft:`${h}px`,display:"flex"},b={width:`${r}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return d("div",{class:f.layerRow,key:"size-ramp-preview",styles:_},d("div",{class:this.classes(f.symbolContainer,f.sizeRampHorizontal),styles:y},i.infos.map((C,w)=>d("div",{key:w,class:f.symbol,bind:C.preview,afterCreate:z}))),u?d("div",{class:f.univariateAboveAndBelowColorRamp,styles:S,key:"color-ramp-preview"},d("div",{bind:u,afterCreate:z}),d("div",{bind:c,afterCreate:z})):null,d("div",{class:f.layerInfo},d("div",{class:f.rampLabelsContainer,styles:b},m)))}_renderUnivariateColorSizeRamp(e,t,s){const{sizeRampElement:i,colorRampElement:l}=Mt(e,"horizontal");if(!i)return null;const r=Pe(i,"full",!1,"horizontal"),n=te(i,"full",!1,"horizontal"),a=ee(l,{width:n,height:12,rampAlignment:"horizontal",opacity:t,type:"full",effectList:s}),o=Le(i,"card"),u=i.infos.length-1,c=i.infos.map((_,y)=>y===0||y===u?d("div",{key:y},_.label):null),h={display:"flex",flexDirection:"column"},p={display:"flex",flexDirection:"row"},g={marginTop:"3px",marginLeft:`${o}px`,display:"flex"},m={width:`${r}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return d("div",{class:f.layerRow,key:"size-ramp-preview",styles:h},d("div",{class:this.classes(f.symbolContainer,f.sizeRampHorizontal),styles:p},i.infos.map((_,y)=>d("div",{key:y,class:f.symbol,bind:_.preview,afterCreate:z}))),d("div",{class:f.univariateAboveAndBelowColorRamp,styles:g,key:"color-ramp-preview"},d("div",{bind:a,afterCreate:z})),d("div",{class:f.layerInfo},d("div",{class:f.rampLabelsContainer,styles:m},c)))}_renderLegendForElementInfo(e,t,s,i){const l=t.layer;if(e.type)return this._renderLegendForElement(e,t,i);const r=Nt(l,s);if(e.preview){var n,a;if(!e.symbol||e.symbol.type.indexOf("simple-fill")===-1){if(!e.label)return d("div",{key:i,bind:e.preview,afterCreate:z});const A={[f.symbolCell]:this._hasIndicators};return d("div",{key:i,class:this.classes(f.layerRow,{[f.symbolRow]:this._hasIndicators})},d("div",{class:this.classes(A),bind:e.preview,afterCreate:z}),d("div",{class:this.classes(f.imageLabel,{[f.labelCell]:this._hasIndicators})},se(this.messages,e.label,!1)||""))}let o=255,u=255,c=255,h=0,p=255,g=255,m=255,_=0;const y=e.symbol.color&&e.symbol.color.a,S=e.symbol.outline&&e.symbol.outline.color&&e.symbol.outline.color.a;y&&(o=e.symbol.color.r,u=e.symbol.color.g,c=e.symbol.color.b,h=e.symbol.color.a*l.opacity),S&&(p=e.symbol.outline.color.r,g=e.symbol.outline.color.g,m=e.symbol.outline.color.b,_=e.symbol.outline.color.a*l.opacity);const b=(n=(a=e.symbol.color)==null?void 0:a.isBright)==null||n,C=b?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)",w={background:y?`rgba(${o}, ${u}, ${c}, ${h})`:"none",color:b?"black":"white",textShadow:`-1px -1px 0 ${C},
                                              1px -1px 0 ${C},
                                              -1px 1px 0 ${C},
                                              1px 1px 0 ${C}`,border:S?`1px solid rgba(${p}, ${g}, ${m}, ${_})`:"none",filter:Ee(t.effectList)};return d("div",{key:i,class:f.layerRow},d("div",{class:f.labelElement,styles:w}," ",e.label," "))}if(e.src){const o=this._renderImage(e,l,r);return d("div",{key:i,class:f.layerRow},o,d("div",{class:f.imageLabel},e.label||""))}}_renderImage(e,t,s){const{label:i,src:l,opacity:r}=e,n={[f.imageryLayerStretchedImage]:s,[f.symbol]:!s},a={opacity:`${r!=null?r:t.opacity}`};return d("img",{alt:se(this.messages,i,!1),src:l,border:0,width:e.width,height:e.height,class:this.classes(n),styles:a})}_renderSizeRampLines(e){const t=e.infos,s=t[0],i=t[t.length-1],l=s.symbol,r=this._hasIndicators,n=P(s.size+s.outlineSize)*ie,a=P(i.size+i.outlineSize)*ie,o=r?n:n+50*ie,u=r?n/2+50*ie:n,c=Pi(l),h=qi(l),p=document.createElement("canvas");p.width=o,p.height=u,p.style.width=p.width/ie+"px",p.style.height=p.height/ie+"px";const g=p.getContext("2d");if(r){g.beginPath();const m=0,_=0,y=o/2-a/2,S=u;g.moveTo(m,_),g.lineTo(y,S);const b=o,C=0,w=o/2+a/2,A=u;g.moveTo(b,C),g.lineTo(w,A)}else{g.beginPath();const m=0,_=u/2-a/2,y=o,S=0;g.moveTo(m,_),g.lineTo(y,S);const b=0,C=u/2+a/2,w=o,A=u;g.moveTo(b,C),g.lineTo(w,A)}return g.strokeStyle=Di,g.stroke(),d("div",{bind:p,afterCreate:z,styles:r?{display:"flex",marginTop:`-${c?0:h?n/2:0}px`,marginBottom:`-${c?a:h?a/2:0}px`}:{display:"flex",marginRight:`-${c?0:h?n/2:0}px`,marginLeft:`-${c?0:h?a/2:0}px`}})}_renderSizeRamp(e,t){const s=e.infos,i=s[0].label,l=s[s.length-1].label;let r=s[0].preview,n=s[s.length-1].preview;const a=this._hasIndicators,o={"flex-direction":a?"column":"row-reverse"};r&&(r=r.cloneNode(!0),r.style.display="flex"),n&&(n=n.cloneNode(!0),n.style.display="flex");const u={opacity:t!=null?`${t}`:""};return d("div",{class:this.classes(f.layerRow,{[f.sizeRampRow]:a})},d("div",{class:f.rampLabel},a?i:l),d("div",{class:f.sizeRampContainer,styles:o},d("div",{bind:r,afterCreate:z,class:f.sizeRampPreview,styles:u}),this._renderSizeRampLines(e),d("div",{bind:n,afterCreate:z,class:f.sizeRampContainer,styles:u})),d("div",{class:f.rampLabel},a?l:i))}_renderLegendForRamp(e,t,s){const i=e.infos,l=e.type==="heatmap-ramp",r=i.length-1,n=Bi,a=r>2&&!l?Mi*r:Oi,o=a+20,u=10,c=i.slice(0).reverse();c.forEach((w,A)=>{w.offset=l?w.ratio:A/r});const h=c.length-1,p=c.length%2!=0&&c[c.length/2|0],g=p&&d("div",{class:f.intervalSeparatorsContainer},d("div",{class:f.intervalSeparator},"|"),d("div",{class:f.rampLabel},p.label)),m=i[i.length-1].label,_=i[0].label,y=[[{shape:{type:"path",path:`M0 ${n/2} L${u} 0 L${u} ${n} Z`},fill:c[0].color,stroke:{width:0}},{shape:{type:"rect",x:u,y:0,width:a,height:n},fill:{type:"linear",x1:u,y1:0,x2:a+u,y2:0,colors:c},stroke:{width:0}},{shape:{type:"path",path:`M${a+u} 0 L${o} ${n/2} L${a+u} ${n} Z`},fill:c[h].color,stroke:{width:0}}]],S=Ss(y,o,n),{messages:b}=this,C={filter:Ee(s),opacity:t==null?null:`${t}`};return d("div",{class:f.layerRow},d("div",{class:f.rampLabel},l?b[m]:m),d("div",{class:f.symbolContainer},d("div",{styles:C},S),g),d("div",{class:f.rampLabel},l?b[_]:_))}};v([I()],B.prototype,"activeLayerInfos",void 0),v([I()],B.prototype,"headingLevel",void 0),v([I()],B.prototype,"layout",void 0),v([I(),he("esri/widgets/Legend/t9n/Legend")],B.prototype,"messages",void 0),v([I(),he("esri/t9n/common")],B.prototype,"messagesCommon",void 0),v([I({readOnly:!0})],B.prototype,"type",void 0),v([I()],B.prototype,"view",void 0),v([us()],B.prototype,"_selectSection",null),B=v([ae("esri.widgets.Legend.styles.Card")],B);const He=B,L={service:"esri-legend__service",label:"esri-legend__service-label",layer:"esri-legend__layer",groupLayer:"esri-legend__group-layer",groupLayerChild:"esri-legend__group-layer-child",layerTable:"esri-legend__layer-table",layerTableSizeRamp:"esri-legend__layer-table--size-ramp",layerChildTable:"esri-legend__layer-child-table",layerCaption:"esri-legend__layer-caption",layerBody:"esri-legend__layer-body",layerRow:"esri-legend__layer-row",layerCell:"esri-legend__layer-cell",layerInfo:"esri-legend__layer-cell esri-legend__layer-cell--info",imageryLayerStretchedImage:"esri-legend__imagery-layer-image--stretched",imageryLayerCellStretched:"esri-legend__imagery-layer-cell--stretched",imageryLayerInfoStretched:"esri-legend__imagery-layer-info--stretched",symbolContainer:"esri-legend__layer-cell esri-legend__layer-cell--symbols",symbol:"esri-legend__symbol",rampContainer:"esri-legend__ramps",sizeRamp:"esri-legend__size-ramp",colorRamp:"esri-legend__color-ramp",opacityRamp:"esri-legend__opacity-ramp",borderlessRamp:"esri-legend__borderless-ramp",rampTick:"esri-legend__ramp-tick",rampFirstTick:"esri-legend__ramp-tick-first",rampLastTick:"esri-legend__ramp-tick-last",rampLabelsContainer:"esri-legend__ramp-labels",rampLabel:"esri-legend__ramp-label",univariateAboveAndBelowSymbol:"esri-univariate-above-and-below-ramp__symbol",univariateAboveAndBelowLabel:"esri-univariate-above-and-below-ramp__label",message:"esri-legend__message",header:"esri-widget__heading",hidden:"esri-hidden"},Hi="esri-legend__",Ui=24,Ot={display:"flex",alignItems:"flex-start"},Ue={marginLeft:"3px"},le={display:"table-cell",verticalAlign:"middle"};let Q=class extends xe{constructor(e,t){super(e,t),this.activeLayerInfos=null,this.headingLevel=3,this.messages=null,this.type="classic"}render(){const e=this.activeLayerInfos,t=e&&e.toArray().map(s=>this._renderLegendForLayer(s)).filter(s=>!!s);return d("div",null,t&&t.length?t:d("div",{class:L.message},this.messages.noLegend))}_renderLegendForLayer(e){if(!e.ready)return null;const t=!!e.children.length,s=`${Hi}${e.layer.uid}-version-${e.version}`,i=e.title?pe({level:this.headingLevel,class:this.classes(L.header,L.label)},e.title):null;if(t){const l=e.children.map(r=>this._renderLegendForLayer(r)).toArray();return d("div",{key:s,class:this.classes(L.service,L.groupLayer)},i,l)}{const l=e.legendElements;if(l&&!l.length)return null;const r=l.map(a=>this._renderLegendForElement(a,e.layer,e.effectList)).filter(a=>!!a);if(!r.length)return null;const n={[L.groupLayerChild]:!!e.parent};return d("div",{key:s,class:this.classes(L.service,n),tabIndex:0},i,d("div",{class:L.layer},r))}}_renderLegendForElement(e,t,s,i){const l=e.type==="color-ramp",r=e.type==="opacity-ramp",n=e.type==="size-ramp";let a=null;if(e.type==="symbol-table"||n){const g=e.infos.map(m=>this._renderLegendForElementInfo(m,t,s,n,e.legendType)).filter(m=>!!m);g.length&&(a=d("div",{class:L.layerBody},g))}else e.type==="color-ramp"||e.type==="opacity-ramp"||e.type==="heatmap-ramp"||e.type==="stretch-ramp"?a=this._renderLegendForRamp(e,t.opacity):e.type==="relationship-ramp"?a=Vt(e,this.id,t.opacity,s):e.type==="univariate-above-and-below-ramp"?a=this._renderUnivariateAboveAndBelowRamp(e,t.opacity,s):e.type==="univariate-color-size-ramp"&&(a=this._renderUnivariateColorSizeRamp(e,t.opacity,s));if(!a)return null;const o=e.title;let u=null;if(typeof o=="string")u=o;else if(o){const g=se(this.messages,o,l||r);u=Bt(o,l||r)&&o.title?`${o.title} (${g})`:g}const c=i?L.layerChildTable:L.layerTable,h=u?d("div",{class:L.layerCaption},u):null,p={[L.layerTableSizeRamp]:n||!i};return d("div",{class:this.classes(c,p)},h,a)}_renderUnivariateAboveAndBelowRamp(e,t,s){const{sizeRampElement:i,colorRampElement:l}=Ft(e,t);if(!i)return null;const r=te(i,"above",!0),n=te(i,"below",!0),a=12,o=ee(l,{width:a,height:r,rampAlignment:"vertical",opacity:t,type:"above",effectList:s}),u=ee(l,{width:a,height:n,rampAlignment:"vertical",opacity:t,type:"below",effectList:s}),c=Le(i),h=i.infos.map(w=>w.label),p=h.map((w,A)=>A===0?d("div",{key:A,class:w?o?L.univariateAboveAndBelowLabel:L.rampLabel:null},w):A===2?d("div",null):null),g=h.length-1,m=Math.floor(h.length/2),_=h.map((w,A)=>A===m||A===g?d("div",{key:A,class:w?o?L.univariateAboveAndBelowLabel:L.rampLabel:null},w):null),y={display:"table-cell",verticalAlign:"middle"},S={marginTop:`${c}px`},b={height:`${r}px`},C={height:`${n}px`};return d("div",{key:"univariate-above-and-below-ramp-preview",styles:Ot},d("div",{class:L.layerBody},i.infos.map((w,A)=>d("div",{class:this.classes(L.layerRow,L.sizeRamp)},d("div",{class:L.symbol,styles:y,bind:w.preview,afterCreate:z}),o||A%2!=0?null:d("div",{class:L.layerInfo},h[A])))),o?d("div",{styles:S,key:"color-ramp-preview"},d("div",{styles:Ue},d("div",{styles:le},d("div",{class:L.rampContainer,bind:o,afterCreate:z})),d("div",{styles:le},d("div",{class:L.rampLabelsContainer,styles:b},p))),d("div",{styles:Ue},d("div",{styles:le},d("div",{class:L.rampContainer,bind:u,afterCreate:z})),d("div",{styles:le},d("div",{class:L.rampLabelsContainer,styles:C},_)))):null)}_renderUnivariateColorSizeRamp(e,t,s){const{sizeRampElement:i,colorRampElement:l}=Mt(e);if(!i)return null;const r=Le(i),n=12,a=te(i,"full",!1),o=ee(l,{width:n,height:a,rampAlignment:"vertical",opacity:t,type:"full",effectList:s}),u=i.infos.length-1,c=i.infos.map((m,_)=>_===0||_===u?d("div",{key:_,class:m.label?l?L.univariateAboveAndBelowLabel:L.rampLabel:null},m.label):null),h={display:"table-cell",verticalAlign:"middle"},p={marginTop:`${r}px`},g={height:`${a}px`};return d("div",{key:"univariate-above-and-below-ramp-preview",styles:Ot},d("div",{class:L.layerBody},i.infos.map(m=>d("div",{class:this.classes(L.layerRow,L.sizeRamp)},d("div",{class:L.symbol,styles:h,bind:m.preview,afterCreate:z})))),d("div",{styles:p,key:"color-ramp-preview"},d("div",{styles:Ue},d("div",{styles:le},d("div",{class:L.rampContainer,bind:o,afterCreate:z})),d("div",{styles:le},d("div",{class:L.rampLabelsContainer,styles:g},c)))))}_renderLegendForRamp(e,t){const s=e.infos,i=e.type==="opacity-ramp",l=e.type==="heatmap-ramp",r=e.type==="stretch-ramp",n=e.preview,a=i?L.opacityRamp:"";n.className=`${L.colorRamp} ${a}`,t!=null&&(n.style.opacity=t.toString());const o=s.map(h=>d("div",{class:h.label?L.rampLabel:null},l?this.messages[h.label]:r?this._getStretchStopLabel(h):h.label)),u={width:`${Ui}px`},c={height:n.style.height};return d("div",{class:L.layerRow},d("div",{class:L.symbolContainer,styles:u},d("div",{class:L.rampContainer,bind:n,afterCreate:z})),d("div",{class:L.layerInfo},d("div",{class:L.rampLabelsContainer,styles:c},o)))}_getStretchStopLabel(e){return e.label?this.messages[e.label]+": "+(typeof e.value=="string"?e.value:Se(e.value,{style:"decimal",notation:e.value.toString().indexOf("e")>-1?"scientific":"standard"})):""}_renderLegendForElementInfo(e,t,s,i,l){if(e.type)return this._renderLegendForElement(e,t,s,!0);let r=null;const n=Nt(t,l);if(e.preview?r=d("div",{class:L.symbol,bind:e.preview,afterCreate:z}):e.src&&(r=this._renderImage(e,t,n)),!r)return null;const a={[L.imageryLayerInfoStretched]:n},o={[L.imageryLayerInfoStretched]:n,[L.sizeRamp]:!n&&i};return d("div",{class:L.layerRow},d("div",{class:this.classes(L.symbolContainer,o)},r),d("div",{class:this.classes(L.layerInfo,a)},se(this.messages,e.label,!1)||""))}_renderImage(e,t,s){const{label:i,src:l,opacity:r}=e,n={[L.imageryLayerStretchedImage]:s,[L.symbol]:!s},a={opacity:`${r!=null?r:t.opacity}`};return d("img",{alt:se(this.messages,i,!1),src:l,border:0,width:e.width,height:e.height,class:this.classes(n),styles:a})}};v([I()],Q.prototype,"activeLayerInfos",void 0),v([I()],Q.prototype,"headingLevel",void 0),v([I(),he("esri/widgets/Legend/t9n/Legend")],Q.prototype,"messages",void 0),v([I({readOnly:!0})],Q.prototype,"type",void 0),Q=v([ae("esri.widgets.Legend.styles.Classic")],Q);const re=Q,we={base:"esri-legend",widget:"esri-widget",panel:"esri-widget--panel",widgetIcon:"esri-icon-layer-list"};let V=class extends xe{constructor(e,t){super(e,t),this._handles=new de,this.activeLayerInfos=null,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.headingLevel=3,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.iconClass=we.widgetIcon,this.label=void 0,this.layerInfos=null,this.messages=null,this.style=new re,this.view=null,this.viewModel=new Ri}initialize(){this.own(ue(this,"view","resize",()=>this.scheduleRender()),ue(this,"activeLayerInfos","change",()=>this._refreshActiveLayerInfos(this.activeLayerInfos)),k(this,"headingLevel",e=>{const{style:t}=this;t&&(t.headingLevel=e)}),oe(this,"style",(e,t)=>{t&&e!==t&&t.destroy(),e&&(e.activeLayerInfos=this.activeLayerInfos,e.type==="card"&&(e.view=this.view),e.headingLevel=this.headingLevel)}))}destroy(){this._handles.destroy(),this._handles=null}castStyle(e){if(e instanceof He||e instanceof re)return e;if(typeof e=="string")return e==="card"?new He:new re;if(e&&typeof e.type=="string"){const t=O({},e);return delete t.type,new(e.type==="card"?He:re)(t)}return new re}render(){return d("div",{class:this.classes(we.base,we.widget,this.style instanceof re?we.panel:null)},this.style.render())}_refreshActiveLayerInfos(e){this._handles.removeAll(),e.forEach(t=>this._renderOnActiveLayerInfoChange(t)),this.scheduleRender()}_renderOnActiveLayerInfoChange(e){const t=oe(e,"version",()=>this.scheduleRender());this._handles.add(t,`version_${e.layer.uid}`);const s=ue(e,"children","change",()=>{e.children.forEach(i=>this._renderOnActiveLayerInfoChange(i))});this._handles.add(s,`children_${e.layer.uid}`),e.children.forEach(i=>this._renderOnActiveLayerInfoChange(i))}};v([H("viewModel.activeLayerInfos")],V.prototype,"activeLayerInfos",void 0),v([H("viewModel.basemapLegendVisible")],V.prototype,"basemapLegendVisible",void 0),v([H("viewModel.groundLegendVisible")],V.prototype,"groundLegendVisible",void 0),v([I()],V.prototype,"headingLevel",void 0),v([H("viewModel.hideLayersNotInCurrentView")],V.prototype,"hideLayersNotInCurrentView",void 0),v([H("viewModel.keepCacheOnDestroy")],V.prototype,"keepCacheOnDestroy",void 0),v([H("viewModel.respectLayerVisibility")],V.prototype,"respectLayerVisibility",void 0),v([I()],V.prototype,"iconClass",void 0),v([I({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],V.prototype,"label",void 0),v([H("viewModel.layerInfos")],V.prototype,"layerInfos",void 0),v([I(),he("esri/widgets/Legend/t9n/Legend")],V.prototype,"messages",void 0),v([I()],V.prototype,"style",void 0),v([ys("style")],V.prototype,"castStyle",null),v([H("viewModel.view")],V.prototype,"view",void 0),v([I()],V.prototype,"viewModel",void 0),V=v([ae("esri.widgets.Legend")],V);const nl=V;export{nl as default};
